/*

##全局函数  
##gFunc
	xLog("str")
	xLogFlush()

	注意事项：
	1. 默认 打码兔 识别验证码
	2. 设置 相应坐标
	3. F8 设置， 验证辅助识别码   前  中   后 ，对应的值
	4. 设置  开始识别时间  和   提交验证码最后时间
	5. 注意建好 必要 目录  d:\jppweb
	6. 设置录像程序 alt +k 开始暂停；  alt+l 停止录像
	7. alt+i  停止、开始模拟鼠标双击 取  最新最高价 
	
	
	8 识别码前、中、后3个都要确认
	
	
	
	F1/|： 当前最高价（默认）再加300并提交申请验证码
	F2/`： 取消输入验证码
	F3/ENTER： 确认提交验证码
	F4： 确认验证码
	F5： 自定义加价
	F6： 当前最高价（默认）再加1000并提交申请验证码
	F7： 自动识别并输入验证码
	F8： 识别码计算

	F10: 取坐标
	
	
	=： 登录
	[： 首次出价
	]:  二次出价
	
	
	
	拍卖时间 投放数量 最低成交价 平均成交价 最低成交价截至时间 投标人数 
	2015年1月 7990 74000 74216 11:02:48 第2位 98203 
	2015年2月 7653 76500 76618 11:29:49 第73位 103224 
	2015年3月 7406 74600 74830 11:20:16 第6位 132690 
	2015年4月 8288 80600 80759 11:29:41 第115位 152298 
	2015年5月 7482 79000 79099 11:29:53 第20位 156007 
	2015年6月 7441 80000 80020 11:29:59 第512位 172205 
 	2015年7月 7531 83100 83171 11:29:55 第670位 166302 
 	2015年8月 7454 82600 82642 11:29:58 第949位 166939 
 	2015年9月  8727 82100 82172 11:29:58 第540位  165765 
 	2015年10月 7763  85300 85424  11:29:52  第72位 170995  

	问题：
	1. 统计  42秒最高价 到 最低档 价格变动  档位， 确定伏击 加价
		统计最低档价格出现的时间
	2. 首次出价 和 第二次 出价 提示 验证码驱动错误 的  提示，自动化过程中，要考虑
	3. 记录行情文件
	
*/


import win.ui;
/*DSG{{*/
mainForm = ..win.form(cls="jppForm";text="好运来拍牌";right=844;bottom=673;edge=1;frame=1)
mainForm.add(
button={cls="button";text="重启定时器";left=439;top=439;right=514;bottom=473;z=58};
button10={cls="button";text="二次出价ctrl4";left=699;top=613;right=824;bottom=647;z=92};
button11={cls="button";text="进入系统ctrl1";left=701;top=493;right=826;bottom=527;z=93};
button12={cls="button";text="模拟出价ctrl6";left=698;top=405;right=823;bottom=439;z=94};
button13={cls="button";text="BP";left=378;top=358;right=407;bottom=392;z=98};
button14={cls="button";text="公司首次出价ctrl7+20000";left=501;top=495;right=654;bottom=529;z=99};
button2={cls="button";text="重新加载配置";left=544;top=442;right=624;bottom=476;z=59};
button3={cls="button";text="启动行情服务";left=447;top=366;right=565;bottom=400;z=74};
button4={cls="button";text="发送重启定时器及配置命令";left=576;top=365;right=729;bottom=399;z=75};
button5={cls="button";text="手动发布最高价";left=694;top=262;right=812;bottom=296;z=83};
button6={cls="button";text="自动发布最高价";left=696;top=305;right=814;bottom=339;z=84};
button7={cls="button";text="最终出价ctrl5";left=699;top=444;right=824;bottom=478;z=89};
button8={cls="button";text="登陆ctrl2";left=702;top=534;right=827;bottom=568;z=90};
button9={cls="button";text="首次出价ctrl3";left=701;top=575;right=826;bottom=609;z=91};
checkbox={cls="checkbox";text="手动验证码";left=620;top=201;right=706;bottom=219;z=85};
checkbox2={cls="checkbox";text="手动提交验证码";left=709;top=201;right=817;bottom=219;z=88};
combobox2={cls="combobox";left=540;top=407;right=660;bottom=427;edge=1;items={"jpp";"dmt"};mode="dropdown";z=57};
edit={cls="edit";left=98;top=194;right=245;bottom=219;edge=1;multiline=1;z=18};
edit10={cls="edit";text="edit10";left=288;top=403;right=380;bottom=428;edge=1;multiline=1;z=53};
edit11={cls="edit";text="edit11";left=290;top=428;right=382;bottom=453;edge=1;multiline=1;z=54};
edit12={cls="edit";text="edit12";left=289;top=454;right=381;bottom=479;edge=1;multiline=1;z=55};
edit13={cls="edit";text="edit13";left=524;top=270;right=616;bottom=295;edge=1;multiline=1;z=76};
edit14={cls="edit";text="edit14";left=536;top=300;right=628;bottom=325;edge=1;multiline=1;z=78};
edit15={cls="edit";text="edit15";left=536;top=329;right=628;bottom=354;edge=1;multiline=1;z=80};
edit16={cls="edit";text="10000";left=702;top=231;right=794;bottom=259;edge=1;multiline=1;z=82};
edit17={cls="edit";text="edit17";left=290;top=484;right=382;bottom=509;edge=1;multiline=1;z=96};
edit18={cls="edit";text="edit181111111";left=82;top=481;right=222;bottom=535;ah=1;aw=1;color=255;edge=1;font=LOGFONT( h=-35;weight=700 );multiline=1;z=100};
edit2={cls="edit";text="300";left=98;top=236;right=245;bottom=261;edge=1;multiline=1;z=20};
edit3={cls="edit";left=98;top=124;right=245;bottom=149;edge=1;multiline=1;z=8};
edit4={cls="edit";text="1000";left=98;top=271;right=195;bottom=296;edge=1;multiline=1;z=22};
edit5={cls="edit";text="edit5";left=291;top=324;right=383;bottom=349;edge=1;multiline=1;z=33};
edit6={cls="edit";text="112948";left=107;top=306;right=199;bottom=331;edge=1;multiline=1;z=38};
edit7={cls="edit";text="112950";left=106;top=340;right=198;bottom=365;edge=1;multiline=1;z=39};
edit8={cls="edit";text="edit8";left=114;top=415;right=206;bottom=440;edge=1;multiline=1;z=44};
edit9={cls="edit";text="112954";left=149;top=452;right=241;bottom=477;edge=1;multiline=1;z=47};
groupbox={cls="groupbox";text="鼠标移动到相应位置按F10保存坐标";left=13;top=8;right=834;bottom=542;edge=1;z=1};
hbtn={cls="button";text="H";left=346;top=357;right=375;bottom=391;z=36};
picturebox={cls="picturebox";left=771;top=14;right=788;bottom=31;hide=1;image=$"\jpp-code.jpg";z=12};
picturebox2={cls="picturebox";left=98;top=153;right=238;bottom=189;z=16};
picturebox3={cls="picturebox";left=693;top=25;right=833;bottom=35;image=$"\qq.jpg";z=24};
picturebox4={cls="picturebox";left=770;top=21;right=784;bottom=36;image=$"\聚拍牌1.jpg";z=26};
picturebox5={cls="picturebox";left=265;top=281;right=405;bottom=317;z=32};
picturebox6={cls="picturebox";left=36;top=375;right=176;bottom=411;z=45};
Qbtn={cls="button";text="Q";left=288;top=357;right=317;bottom=391;z=34};
radiobutton={cls="radiobutton";text="加300按钮坐标";left=31;top=35;right=129;bottom=52;z=2};
radiobutton10={cls="radiobutton";text="识别码右下坐标";left=267;top=124;right=379;bottom=142;z=31};
radiobutton11={cls="radiobutton";text="验证码输入坐标";left=267;top=153;right=379;bottom=171;z=37};
radiobutton12={cls="radiobutton";text="最高价左上";left=266;top=180;right=378;bottom=198;z=42};
radiobutton13={cls="radiobutton";text="最高价右下";left=268;top=209;right=380;bottom=227;z=43};
radiobutton14={cls="radiobutton";text="登录用户坐标";left=446;top=43;right=558;bottom=61;z=60};
radiobutton15={cls="radiobutton";text="登录密码坐标";left=447;top=68;right=559;bottom=86;z=61};
radiobutton16={cls="radiobutton";text="登录验证码输入坐标";left=447;top=97;right=583;bottom=115;z=62};
radiobutton17={cls="radiobutton";text="登录yzm左上坐标";left=446;top=121;right=582;bottom=139;z=63};
radiobutton18={cls="radiobutton";text="登录yzm右下坐标";left=446;top=145;right=582;bottom=163;z=64};
radiobutton19={cls="radiobutton";text="首次出价输入1坐标";left=452;top=198;right=588;bottom=216;z=65};
radiobutton2={cls="radiobutton";text="出价输入框坐标";left=143;top=35;right=247;bottom=54;z=3};
radiobutton20={cls="radiobutton";text="首次出价输入2坐标";left=454;top=221;right=590;bottom=239;z=66};
radiobutton21={cls="radiobutton";text="首次出价按钮坐标";left=452;top=242;right=588;bottom=260;z=67};
radiobutton22={cls="radiobutton";text="重登录身份证输入坐标";left=603;top=71;right=751;bottom=89;z=68};
radiobutton23={cls="radiobutton";text="重登陆yzm输入坐标";left=605;top=99;right=741;bottom=117;z=69};
radiobutton24={cls="radiobutton";text="重登录yzm左上坐标";left=604;top=125;right=740;bottom=143;z=70};
radiobutton25={cls="radiobutton";text="重登录yzm左上坐标";left=605;top=149;right=741;bottom=167;z=71};
radiobutton26={cls="radiobutton";text="登录按钮坐标";left=446;top=171;right=582;bottom=189;z=72};
radiobutton27={cls="radiobutton";text="重登陆按钮坐标";left=608;top=172;right=744;bottom=190;z=73};
radiobutton28={cls="radiobutton";text="自定义加价输入框坐标";left=270;top=236;right=419;bottom=254;z=86};
radiobutton29={cls="radiobutton";text="自定义加价按钮坐标";left=270;top=260;right=406;bottom=278;z=87};
radiobutton3={cls="radiobutton";text="提交出价取验证码坐标";left=269;top=37;right=410;bottom=57;z=4};
radiobutton4={cls="radiobutton";text="确认出价按钮坐标";left=31;top=67;right=141;bottom=84;z=5};
radiobutton5={cls="radiobutton";text="取消出价按钮坐标";left=143;top=67;right=255;bottom=87;z=6};
radiobutton6={cls="radiobutton";text="提示框确认按钮坐标";left=261;top=66;right=390;bottom=86;z=7};
radiobutton7={cls="radiobutton";text="验证码左上坐标";left=31;top=96;right=143;bottom=116;z=14};
radiobutton8={cls="radiobutton";text="验证码右下坐标";left=144;top=97;right=244;bottom=113;z=15};
radiobutton9={cls="radiobutton";text="识别码左上坐标";left=267;top=95;right=379;bottom=115;z=30};
richedit={cls="richedit";text="
【聚・拍牌】-一键快捷出价，使用帮助：

F1： 当前最高价（默认）再加300并提交申请验证码
F2： 取消输入验证码
F3： 确认提交验证码
F4： 提示框确认
F5： 价格加100
F6： 当前最高价（默认）再加1000并提交申请验证码
F7： 自动识别并输入验证码
F8： 识别码计算

关于【聚・拍牌】
以互联网+为背景，创新推出众筹拍牌的模式！
尽显【人人为我，我为人人】的情怀！！\res

小伙伴们快来一起击碎久拍不中的魔咒吧！！！
向高成本拍牌说NO！！！！

聚拍牌官方发布：
软件及相关版权归【聚・拍牌】所有，违者必究！";left=439;top=9;right=731;bottom=22;edge=1;link=1;multiline=1;z=10};
richedit2={cls="richedit";text="【聚・拍牌】官方QQ群：475052526  

【聚・拍牌】
提供线上平台，将线下需要拍牌的‘拍友’联系起来，是抱团拍牌，互帮互助，化零为整的思路。
通过线上渠道甄选优质拍牌服务者，从关注聚拍牌的用户甄选出优质需求‘拍友’，高信用‘拍友’。
每月限额，由聚拍牌为你买单，资金由聚拍牌公益基金支取。
当成功拍得拍照后，由获得牌照的‘拍友’自愿捐献部分资金至基金，作为供后续‘拍友’提供服务的资金。

【聚・拍牌】聚集长时间拍牌不中‘拍友’，来为这些‘拍友’，
提供了一个相对较低成本，成功率又很高的方案。
公益基金的建立和募集又体现了人人为我，我为人人的情怀。
不需要拼颜值，不需要拼人品，不需要拼土豪，在聚拍牌人人平等！
请快加入聚拍牌大家庭吧，扫一扫，不要错过低价拍牌的机会！！

";left=17;top=578;right=690;bottom=669;edge=1;link=1;multiline=1;wrap=1;z=11};
static={cls="static";text="验证码";left=32;top=163;right=120;bottom=179;transparent=1;z=13};
static10={cls="static";text="【聚・拍牌】";left=576;top=13;right=709;bottom=20;ah=1;aw=1;color=8421376;font=LOGFONT( name='华文琥珀';h=-20;weight=700 );transparent=1;z=29};
static11={cls="static";text="出价开始时间";left=32;top=313;right=120;bottom=329;transparent=1;z=40};
static12={cls="static";text="出价结束时间";left=29;top=345;right=117;bottom=361;transparent=1;z=41};
static13={cls="static";text="模拟识别验证码时间";left=25;top=460;right=139;bottom=473;transparent=1;z=46};
static14={cls="static";text="识别码";left=239;top=327;right=312;bottom=343;transparent=1;z=48};
static15={cls="static";text="识别最高价";left=28;top=423;right=101;bottom=439;transparent=1;z=49};
static16={cls="static";text="Q";left=277;top=409;right=291;bottom=425;transparent=1;z=50};
static17={cls="static";text="Z";left=275;top=434;right=289;bottom=452;transparent=1;z=51};
static18={cls="static";text="H";left=273;top=459;right=290;bottom=475;transparent=1;z=52};
static19={cls="static";text="验证码识别方式";left=436;top=412;right=526;bottom=426;transparent=1;z=56};
static2={cls="static";text="当前坐标";left=32;top=130;right=123;bottom=143;transparent=1;z=9};
static20={cls="static";text="登陆时间";left=459;top=275;right=547;bottom=291;transparent=1;z=77};
static21={cls="static";text="首次出价时间";left=457;top=307;right=545;bottom=323;transparent=1;z=79};
static22={cls="static";text="二次出价时间";left=457;top=336;right=545;bottom=352;transparent=1;z=81};
static23={cls="static";text="设置警示价";left=639;top=236;right=727;bottom=252;transparent=1;z=95};
static24={cls="static";text="BP";left=267;top=489;right=292;bottom=505;transparent=1;z=97};
static3={cls="static";text="识别结果";left=32;top=201;right=120;bottom=217;transparent=1;z=17};
static4={cls="static";text="F1加价设置";left=32;top=242;right=120;bottom=257;transparent=1;z=19};
static5={cls="static";text="F6加价设置";left=32;top=277;right=120;bottom=293;transparent=1;z=21};
static6={cls="static";text="扫一扫加【聚・拍牌】
    官方微信公众号";left=715;top=501;right=836;bottom=540;ah=1;aw=1;hide=1;transparent=1;z=23};
static7={cls="static";text="扫一扫加【聚・拍牌】
      官方QQ群";left=707;top=37;right=819;bottom=40;transparent=1;z=25};
static8={cls="static";text="      每月限额
      尽快关注
   
   【聚・拍牌】";left=697;top=35;right=844;bottom=44;ah=1;aw=1;color=8421376;font=LOGFONT( name='华文琥珀';h=-20;weight=700 );transparent=1;z=27};
static9={cls="static";text="有疑问？
速至
官方Q群反馈!

475052526

欢迎
‘拍友’
加入！";left=599;top=8;right=820;bottom=22;ah=1;aw=1;color=8421376;font=LOGFONT( name='华文琥珀';h=-20;weight=700 );transparent=1;z=28};
zbtn={cls="button";text="Z";left=317;top=357;right=346;bottom=391;z=35}
)
/*}}*/

var tmpFmTop = 0;
var newform = ..win.form( top=100;bottom=420;left=1050;right=1250;text="最新价";max=false;min=false)
newform.add(
edtTime   	={cls="edit";text="当前时间";	left=0;top=1;  right=300;bottom=40;color=8;edge=1;font=LOGFONT( h=-28;weight=700 );multiline=1;z=100};
edtFtPrice	={cls="edit";text="估价";		left=0;top=40;right=300;bottom=90;color=16711935;edge=1;font=LOGFONT( h=-32;weight=700 );multiline=1;z=100};
edtNewPrice	={cls="edit";text="最新价";		left=0;top=90;right=300;bottom=140;color=255;edge=1;font=LOGFONT( h=-32;weight=700 );multiline=1;z=100};
edtBidPrice	={cls="edit";text="出价";		left=0;top=140;right=300;bottom=200;color=32768;edge=1;font=LOGFONT( h=-40;weight=700 );multiline=1;z=100};
edtBidTime	={cls="edit";text="出价时间";	left=0;top=200;right=300;bottom=240;color=1024;edge=1;font=LOGFONT( h=-28;weight=700 );multiline=1;z=100};
edtIncAt29	={cls="richedit";text="29分涨幅";	left=0;top=240;right=200;bottom=320;color=255;edge=1;font=LOGFONT( h=-21;weight=700 );multiline=1;z=100};
)

var manualYzm = "0"
var manualBid = "0";
var isYzmOk  = "0";

var yzmType = "jpp"



var lastp00 = 0;
var lastp01 = 0;
var lastp02 = 0;
var lastp03 = 0;
var lastp04 = 0;
var lastp05 = 0;
var lastp06 = 0;
var lastp07 = 0;
var lastp08 = 0;
var lastp09 = 0;
var lastp10 = 0;
var lastp11 = 0;
var lastp12 = 0;
var lastp13 = 0;
var lastp14 = 0;
var lastp15 = 0;
var lastp16 = 0;
var lastp17 = 0;
var lastp18 = 0;
var lastp19 = 0;
var lastp20 = 0;
var lastp21 = 0;
var lastp22 = 0;
var lastp23 = 0;
var lastp24 = 0;
var lastp25 = 0;
var lastp26 = 0;
var lastp27 = 0;
var lastp28 = 0;
var lastp29 = 0;
var lastp30 = 0;
var lastp31 = 0;
var lastp32 = 0;
var lastp33 = 0;
var lastp34 = 0;
var lastp35 = 0;
var lastp36 = 0;
var lastp37 = 0;
var lastp38 = 0;
var lastp39 = 0;
var lastp40 = 0;
var lastp41 = 0;
var lastp42 = 0;
var lastp43 = 0;
var lastp44 = 0;
var lastp45 = 0;
var lastp46 = 0;
var lastp47 = 0;
var lastp48 = 0;
var lastp49 = 0;
var lastp50 = 0;
var lastp51 = 0;
var lastp52 = 0;
var lastp53 = 0;
var lastp54 = 0;
var lastp55 = 0;
var lastp56 = 0;
var lastp57 = 0;
var lastp58 = 0;
var lastp59 = 0;
var lastp60 = 0;

var delta51_50 = 0;
var delta52_50 = 0; 
var delta53_50 = 0; 
var delta54_50 = 0; 
var delta55_50 = 0; 
var deltaLastMin29 = 0;

var bidPriceAt29 = 0;
var bidPriceAt29_1 = 0;
var bidPriceAt29_2 = 0;
var bidPriceAt29_3 = 0;
var bidPriceAt29_4 = 0;

_Beep = ::Kernel32.api("Beep","int(int,int)"); 

mainForm.checkbox.oncommand = function(id,event){
	//mainForm.msgbox( mainForm.checkbox.text );
	if mainForm.checkbox.checked {
		manualYzm = "1"
	}else {
		manualYzm = "0"	
	}
}


mainForm.checkbox2.oncommand = function(id,event){
	//mainForm.msgbox( mainForm.checkbox.text );
	if mainForm.checkbox2.checked {
		manualBid = "1"
	}else {
		manualBid = "0"	
	}
}


mainForm.button6.oncommand = function(id,event){
	//mainForm.msgbox( mainForm.button6.text );
	    if (gStopFlag == "0"){
       		gStopFlag = "1"
       		mainForm.button6.text = mainForm.button6.text + "停止"
       	}else {
       		gStopFlag = "0"
       		mainForm.button6.text = mainForm.button6.text + "开始"
       	}
	
}


mainForm.button5.oncommand = function(id,event){
	//mainForm.msgbox( mainForm.button5.text );
	var tmpPrice = mainForm.edit16.text
	try{
		var num = tonumber(tmpPrice)
		num = num +100
		mainForm.edit16.text = tostring(num)
	}
	catch(e){
		
	}	
	
}


// log module
var tm = time.now();
tm.format="%Y%m%d";
var today = tostring(tm)	
var filename = "/"+today+"-jppweb"+".log"

xfile = io.open(filename,"a+");
xfile.write("log start...",'\n');
xfile.flush();


getNowTime = function(){
	var localtime = time.now()
	//time.now().format="%Y年%m月%d日 %H时%M分%S秒";
	localtime.format="%H:%M:%S";
	var slocaltime = tostring(localtime)
	return slocaltime	
}

getNowTimeNice = function(){
	var localtime = time.now()
	//time.now().format="%Y年%m月%d日 %H时%M分%S秒";
	localtime.format="%H%M%S";
	var slocaltime = tostring(localtime)
	return slocaltime	
}

getNowTimeNiceSS = function(){
	var localtime = time.now()
	//time.now().format="%Y?ê%m??%dè? %Hê±%M・?%S??";
	localtime.format="%S";
	var slocaltime = tostring(localtime)
	return slocaltime	
}


// add  getNowTimeStr function with ms 精度
getNowWithMs = function(){
	//import time
	
	var nowTime = time.now();
	nowTime.format="%H%M%S"
	var nowTimeStr = tostring(nowTime) 
	
	var _, tm = ::Kernel32.GetSystemTime( nowTime )

	var res = string.format("%s%03i",nowTimeStr, tm.milliseconds);	
	
	return res; 
}

getNowWithMsWithSep = function(){
	//import time
	
	var nowTime = time.now();
	nowTime.format="%H:%M:%S"
	var nowTimeStr = tostring(nowTime) 
	
	var _, tm = ::Kernel32.GetSystemTime( nowTime )

	var res = string.format("%s.%03i",nowTimeStr, tm.milliseconds);	
	
	return res; 
}


xLog = function(logstr){
	var localtime = time.now()
	localtime.format="%H:%M:%S";
	var slocaltime = tostring(localtime)
	
	var _, tm = ::Kernel32.GetSystemTime( localtime )
	
	slocaltime = string.format("%s.%03i",slocaltime, tm.milliseconds);	
	//是否 记录日志 增加 开关
	xfile.write(slocaltime, '  ##  ',logstr ,'\n');
	..io.print(slocaltime, '  ##  ',logstr ,'\n')
	xfile.flush();	
}

xLogFlush = function(){
	xfile.flush();
}

mainForm.button4.oncommand = function(id,event){
	//mainForm.msgbox( mainForm.button4.text );
	responder.sendMsg("preload")
	//..io.print(666, responder.sendMsg("preload"))
}

import thread.table; 

subThreadTable = thread.table("subPrice")	

getSubLastPrice = function(){
	return subThreadTable.lastPrice; 
}

io.open()

import cfgTable
isCheckAuth = "0"
autoKeyEnable = true

mainForm.combobox2.oncommand = function(id,event){
	//mainForm.msgbox( mainForm.combobox2.selText );
	yzmType = mainForm.combobox2.selText
}

import time	
import time.ntp

// 加载 打码兔 dll
var dll = raw.loadDll( "\jppweb.dll" );  // 打码兔
jppDecodeByImg = dll.api( "D2File","int (string id, string name, string pwd, string file, int timeout, int type, string vcode)", "stdcall" ); 
gcode = "***************************************************************************************" 
gPrice = "90000"

//打码兔 从本地图片	识别 6位数字 
jppDecode6 = function(imgPath){
	
	gcode = "***************************************************************************************" 
	try{
		err = jppDecodeByImg("d5d65fa8b386642d778055207eb09bf3",  "kaka21", "!@#$qwer", 
 		imgPath, 
 		30,  6,  gcode)	
	}
	catch(e){
		
	}
 		
	if (err < 0){
		//io.print("err", err)	
	}
	
	return gcode, err
}


//打码兔， 从本地图片识别 4位数字
jppDecode4 = function(imgPath){
	
	gcode = "***************************************************************************************" 
	try{
		err = jppDecodeByImg("d5d65fa8b386642d778055207eb09bf3",  "kaka21", "!@#$qwer", 
 		imgPath, 
 		15,  4,  gcode)	
	}
	catch(e){
		
	}
 		
	if (err < 0){
		//io.print("err", err)	
	}
	
	return gcode, err
}

gcodeTest = "***************************************************************************************"

jppDecode6Test = function(imgPath){
	
	gcodeTest = "***************************************************************************************"
	try{
		errTest = jppDecodeByImg("d5d65fa8b386642d778055207eb09bf3",  "kaka21", "!@#$qwer", 
 		imgPath, 
 		20,  6,  gcodeTest)	
	}
	catch(e){
		
	}
	
 		
	if (errTest < 0){
		//io.print("errTest", errTest)	
	}
	
	return gcodeTest, errTest
}

//加载优优DLL
var dllUu = raw.loadDll("\jppwebUu.dll")
//将DLL内部函数 setsoftinfo 定义到本语言
jppDecodeByImgUuSoft=dllUu.api("uu_setSoftInfoA","void(int softid,string skey)", "stdcall")
//将DLL内部函数 login 定义到本语言
jppDecodeByImgUuLogin=dllUu.api("uu_loginA","int(string username,string password )" , "stdcall")
//载入DLL内部函数  uu_easyRecognizeFileA
jppDecodeByImgUuFile=dllUu.api("uu_easyRecognizeFileA","int(int nSoftID, string lpSoftKey, string lpUserName, string lpPassword, string lpPicPath, int nCodeType, string pCodeResult)", "stdcall")
//载入DLL内部函数  uu_easyRecognizeFileAuu_recognizeByCodeTypeAndPathA
jppDecodeByImgUuTypeFile=dllUu.api("uu_recognizeByCodeTypeAndPathA","int(string lpPicPath, int nCodeType, string& pCodeResult)", "stdcall")
jppDecodeByImgUuTypeFileScreen=dllUu.api("uu_recognizeScreenByCodeTypeA","int(int x, int y ,int w ,int h, int nCodeType, string& pCodeResult)", "stdcall")

//初始化 uu dll
//jppDecodeByImgUuSoft(107384, "120bd19922104811a9db710e2a67acc7")
//userid=jppDecodeByImgUuLogin("kaka21uu","!@#$qwer") 


// 优优云 从本地图片 识别 6位数字
jppDecode6uu = function(imgPath){
	gcode = "***********************************************************************" 
	err, gcode=jppDecodeByImgUuTypeFile(imgPath,4006,gcode)	//调用识别函数		
	i = string.indexOf(gcode,"_")
	gcode = string.sub(gcode,i+1,i+6)	
	return gcode, err
}

// 优优云 从截屏 识别 6位数字
jppDecode6uuScreen = function(x, y, w, h){
	gcode = "***********************************************************************" 
	err, gcode=jppDecodeByImgUuTypeFileScreen(x, y, w, h,4006,gcode)	//μ÷ó?ê?±eoˉêy		
	i = string.indexOf(gcode,"_")
	gcode = string.sub(gcode,i+1,i+6)	
	return gcode, err
}




//从本地图片，截取部分图片并保存文件
//GDI+ 图像剪切

import snapImg

// snapImg.snapImgRectFromImgFile("D:\jppweb\imgcode6.jpg", "D:\jppweb\imgcode4.jpg", "q")

//	import process;
//	process.explore_select( "D:\jppweb\imgcode4.jpg")


vcode="***********************************************************************"	//申请一点空间,大概能放下比识别结果长点
codeid = 0


// 配置信息模块
import fsys.ini;

ini=fsys.ini("\cfg.ini")
secSys = ini.getSection("系统信息")

//个性配置，根据ip，取得自己配置
ipSys = ini.getSection("ip")

// 获取clientIp
clientIp = cfgTable.getClientIp()
//cfgTable.splitIpCfgStr(clientCfgByIp)	
xLog("获取当前客户端IP"+clientIp)
..io.print("clientIp", clientIp)
xLogFlush()


setVarFromIni = function(){
	 
	 ini=fsys.ini("\cfg.ini")
	 secSys = ini.getSection("系统信息")
		
	 xPrice300 = secSys.xPrice300
	 yPrice300 = secSys.yPrice300
	
	
	 xPriceEdt = secSys.xPriceEdt
	 yPriceEdt = secSys.yPriceEdt
	
	
	 xPriceBtn = secSys.xPriceBtn
	 yPriceBtn = secSys.yPriceBtn
	
	
	 xConfirmBtn = secSys.xConfirmBtn
	 yConfirmBtn = secSys.yConfirmBtn
	
	 xCancelBtn = secSys.xCancelBtn
	 yCancelBtn = secSys.yCancelBtn
	
	
	 xErrorBtn = secSys.xErrorBtn
	 yErrorBtn = secSys.yErrorBtn
	
	 xImgTopBtn = secSys.xImgTopBtn
	 yImgTopBtn = secSys.yImgTopBtn
	
	 xImgBtomBtn = secSys.xImgBtomBtn
	 yImgBtomBtn = secSys.yImgBtomBtn
	
	 xImgTopBtnFlag = secSys.xImgTopBtnFlag
	 yImgTopBtnFlag = secSys.yImgTopBtnFlag
	
	 xImgBtomBtnFlag = secSys.xImgBtomBtnFlag
	 yImgBtomBtnFlag = secSys.yImgBtomBtnFlag
	
	
	 	xImgTopBtnFlagPrice = secSys.xImgTopBtnFlagPrice
	 	yImgTopBtnFlagPrice = secSys.yImgTopBtnFlagPrice
		
	 	xImgBtomBtnFlagPrice = secSys.xImgBtomBtnFlagPrice
	 	yImgBtomBtnFlagPrice = secSys.yImgBtomBtnFlagPrice
	 	
	// ---	
	 	xUserEdt = secSys.xUserEdt
	 	yUserEdt = secSys.yUserEdt
		
	 	xPwdEdt = secSys.xPwdEdt
	 	yPwdEdt = secSys.yPwdEdt
	 	
	 	xBtnLogin = secSys.xBtnLogin
	 	yBtnLogin = secSys.yBtnLogin
	 	
	 	xImgLoginEdt = secSys.xImgLoginEdt
	 	yImgLoginEdt = secSys.yImgLoginEdt	
	 	
	 	xImgTopLogin = secSys.xImgTopLogin
	 	yImgTopLogin = secSys.yImgTopLogin
		
	 	xImgBtomBtnLogin = secSys.xImgBtomBtnLogin
	    yImgBtomBtnLogin = secSys.yImgBtomBtnLogin
	 	
	 		 	
	 	xBidOnce1Edt = secSys.xBidOnce1Edt
	 	yBidOnce1Edt = secSys.yBidOnce1Edt
	 	
	 	xBidOnce2Edt = secSys.xBidOnce2Edt
	 	yBidOnce2Edt = secSys.yBidOnce2Edt
	 	
	 	xBidOnceBtn = secSys.xBidOnceBtn
	 	yBidOnceBtn = secSys.yBidOnceBtn
	 
	 	xIdNoEdt = secSys.xIdNoEdt
	 	yIdNoEdt = secSys.yIdNoEdt
	 	
	 	
	 	xBtnLogin2 = secSys.xBtnLogin2
	 	yBtnLogin2 = secSys.yBtnLogin2
	 	
	 	
	 	xImgLogin2Edt = secSys.xImgLogin2Edt
	 	yImgLogin2Edt = secSys.yImgLogin2Edt	
	 	
	 	xImgTopLogin2 = secSys.xImgTopLogin2
	 	yImgTopLogin2 = secSys.yImgTopLogin2
		
	 	xImgBtomBtnLogin2 = secSys.xImgBtomBtnLogin2
	    yImgBtomBtnLogin2 = secSys.yImgBtomBtnLogin2
	    
	   	xCustomAddPriceEdt = secSys.xCustomAddPriceEdt
	    yCustomAddPriceEdt = secSys.yCustomAddPriceEdt
	    
	    xCustomAddPriceBtn = secSys.xCustomAddPriceBtn
	    yCustomAddPriceBtn = secSys.yCustomAddPriceBtn
	 	
	 	
	 
	//
	
	 qCode = secSys.qCode
	 zCode = secSys.zCode
	 hCode = secSys.hCode
	 bpCode = secSys.bpCode
		
		
	 xImgEdt = secSys.xImgEdt
	 yImgEdt = secSys.yImgEdt
	
	 f1Price = secSys.f1Price
	 f6Price = secSys.f6Price 
	
	 nowPrice =  secSys.nowPrice
	
	 startTimeStr = secSys.startTimeStr
	 endTimeStr =   secSys.endTimeStr
	
	 bidTimeStr =   secSys.bidTimeStr
	 
	 
	 login1TimeStr = secSys.login1TimeStr
	 bid1TimeStr = secSys.bid1TimeStr
	 bid2TimeStr = secSys.bid2TimeStr
	 
	
	 // 个性配置
	 clientCfgByIp = ini.read("clientCfgByIp",clientIp,"null")
	 
	 //..io.print(588, "clientCfgByIp", clientCfgByIp, clientIp)
	 user, pwd, idNo, priceAdded, priceBefore, timeLine, ip, imgSvrIp, bid1Time, bid2Time, bid3Time, yzmType, bid4Time = cfgTable.splitIpCfgStr(clientCfgByIp)
	 
	 ..io.print("")
	 ..io.print("****************************************")
	 ..io.print(588, "根据clientIp地址，读取配置文件相应配置：", clientIp)
	 ..io.print(588, "电信or联通dx/lt                       ：", bid1Time)
	 ..io.print(588, "最后出价提交时间                      ：", timeLine ）
	 ..io.print(588, "提前100出价时间                       ：", bid2Time)
	 ..io.print(588, "提前200出价时间                       ：", bid4Time)
	  ..io.print(588,"网络获取行情                          ：", bid3Time)
	  ..io.print(588,"自定义加价                            ：", priceAdded)
	 ..io.print("****************************************")
	 ..io.print("")
	 
	 subThreadTable.ip = ip
	 subThreadTable.imgSvrIp = imgSvrIp
	 subThreadTable.yzmType = yzmType
	 subThreadTable.clientIp = clientIp
	 //使用bid3Time 表示 最新价取自网络，还是本地图片识别
	 subThreadTable.useNetPrice = bid3Time  // useNetPrice
	 
	 	subThreadTable.xImgTopBtnFlagPrice = xImgTopBtnFlagPrice
	 	subThreadTable.yImgTopBtnFlagPrice = yImgTopBtnFlagPrice
		
	 	subThreadTable.xImgBtomBtnFlagPrice = xImgBtomBtnFlagPrice
	 	subThreadTable.yImgBtomBtnFlagPrice = yImgBtomBtnFlagPrice
	
	 	
	 xLog(499+"	###	priceSvrIP 行情服务器IP："+subThreadTable.ip) 
	 xLog(499+"	###	imgSvrIp 验证码代理服务器IP："+subThreadTable.imgSvrIp) 
	 xLog(499+"	###	yzmType 验证码识别类型："+subThreadTable.yzmType) 
	 xLog(499+"	###	bid3Time 最后出价时间点："+timeLine) 
	 f1Price = priceAdded
	 bidTimeStr = timeLine
	 
	 // 警示价
	 lowestPriceJS = secSys.lowestPriceJS 
	 xLog(499+"	###	lowestPriceJS 警示价设置："+lowestPriceJS) 
	 
	 //weburl paimai.alltobid.com
	 weburl = secSys.weburl
	 
	 //..io.print(user)
}

xLog("根据ip:"+clientIp+"地址，读取配置文件相应配置")
setVarFromIni()
xLogFlush()

import zeromq

gLastPrice = "80000"
gStopFlag = "1"
openPriceSvr = function(){
	xLog("开启价格服务器")	
	context = zeromq.context(20)
	responder = context.zmq_socket_pub() 
	
	if( ! responder.bind(  "tcp://*:55555") ){ 
    	..io.print( zeromq.lasterr() );  
    	return;
	}
	
	getLastPrice = function(){	
	
		if (gStopFlag == "0" ){
			
			
			import mouse
			mouse.click(xPrice300, yPrice300,true); 
	
			win.delay(100)	
			
			mouse.clickDb(xPriceEdt,yPriceEdt,true)
			win.delay(50)
			
    		import key
    		key.combine("CTRL","a")
    		win.delay(20)
    		key.combine("CTRL","c")
    		win.delay(20)
    		
    		import win.clip
    		gLastPrice = win.clip.read()
    		//nowPrice = strPrice
    		
    		xLog("##lastPrice="+gLastPrice)
    		xLogFlush()
    	}
    	else{
    		var tmpPrice = mainForm.edit16.text
    		if (tmpPrice != "10000"){
    			gLastPrice = mainForm.edit16.text
    		}
    		win.delay(200)
    	}
	
		import math
		try{
			math.randomize()
			result = tostring(math.random(0, 5))
			result = "p"+result+"-"+gLastPrice; 
		}
		catch(e)
		{
			//..io.print("pError")	
			result = "pError"; 
		}
		
		return result; 
	}
	
	//..io.open()
	while (1) {
		replyMsgStr = getLastPrice()
		responder.sendMsg(replyMsgStr)
    	..io.print(replyMsgStr)
    	replyMsgStr = null
    	win.delay(10)
	}
	
	responder.close(); 
	context.term();	
}

subThreadTable.xLog = xLog
subThreadTable.xfile = xfile


subThreadTable.threadRecImgCode4Str = ""
threadRecImgReq = function()
{
	import thread.table; 
	//import subPrice
	var threadReqTab = thread.table("subPrice")
	

	var startTime = ""
	var endTime = ""
	var costTime = ""

	import console
	import io
	import fsys
	import time
	import zeromq
	
	var requester = null;
	var context = null;
	var recvMsg = null;
	var msg = null;
	var recvMsg = null;	
	var hbmsg = zeromq.message("hb")  
	var hbmsgrecv = zeromq.message()  
	
	
	//threadReq.context = context
	//threadReq.recvMsg = recvMsg
	//threadReq.msg = msg
	//threadReq.recvMsg = recvMsg
	//threadReq.hbmsg = hbmsg
	//threadReq.hbmsgrecv = hbmsgrecv

	connect = function(remoteIP){
		..io.print("StartOpenZeromq...", startTime)
			
		context = zeromq.context(1) 
		requester = context.zmq_socket_request() ;
		//threadReq.requester = requester
		//requester.setsockopt(
		
		var	nowTime = time.now()
		nowTime.format="%H%M%S";
		var nowTimeStr = tostring(nowTime) 
		
		if (nowTimeStr <= "112936") or (nowTimeStr >= "113042")
		{		
			threadReqTab.threadRecImgFlag = "hb"
		}
		
		if( requester.connect( "tcp://"+remoteIP+":56666" ) ){
			..io.print("imgSvr connect ok 56666")
		}
		

	}	
	
	close = function(){
		msg.close()
		recvMsg.close()	
		requester.close()
		context.term();	
	}	

	sendHeartBeatMsg = function(){
		..io.print(41, "imgCli sendHeartBeatMsg")
		requester.sendMsg(hbmsg)
		requester.recvMsg(hbmsgrecv);
	}
	
	
	recImgStr4 = function(remoteIP, imgFile){
		//..io.open()
		var resultStr = ""
		
		..io.print("")
		..io.print("")
		
		startTime = time.now()
		startTime.format="%H%M%S";
		..io.print("startOpenImg...", startTime)
		
		endTime = time.now()
		endTime.format="%H%M%S";
		
		var imgFile = io.open(imgFile, "rb");
		imgFile.seek("set")	// to set seek 0
		var imgSize = imgFile.size(1) // get size n bytes use param 1
		
		var rawImg = ..raw.malloc(imgSize, 0)		// init rawMem 0
		imgFile.readBuffer(rawImg, imgSize)		// set rawMew by file binary content 
		imgFile.close()
		
		startTime = time.now()
		startTime.format="%H%M%S";
		..io.print("imgOpened...", startTime)
			
		startTime = time.now()
		startTime.format="%H%M%S";

		
		msg = zeromq.message(rawImg, imgSize)
		
		requester.sendMsg(msg)
		//msg.close();
		
		startTime = time.now()
		startTime.format="%H%M%S";
		..io.print("imgSended...", startTime)
		..io.print("untilImgSendedCost", tonumber(startTime)-tonumber(endTime))
		
		endTime = time.now()
		endTime.format="%H%M%S";
		
		recvMsg = zeromq.message()  
		
		requester.recvMsg(recvMsg);  
		
		
		resultStr =  recvMsg.getString() 	
		io.print ("recvMsg", resultStr);
		
		startTime = time.now()
		startTime.format="%H%M%S";
		..io.print("imgReceived...", startTime, resultStr)
		..io.print("untilImgReceivedCost", tonumber(startTime)-tonumber(endTime))
		
		..io.print("")
		..io.print("")
	

		
	    return resultStr; 
	
	}
	
	
	connect(threadReqTab.imgSvrIp)
	

	//threadReqTab.threadRecImgFlag = "hb"
	//var threadFlag = "0"
	
	while(true){
	   if (threadReqTab.threadRecImgFlag = "recimgreq"){
	   		threadReqTab.threadRecImgFlag = "null"    
	        threadReqTab.threadRecImgCode4Str = recImgStr4(threadReqTab.imgSvrIp, "D:\jppweb\imgcode4.jpg")	                
	   }
	   else if (threadReqTab.threadRecImgFlag = "hb")
	   {
	   	//	threadReqTab.threadRecImgFlag = "null"   
	   //     sendHeartBeatMsg()
	   //     sleep(4000)     
	   }
	   else if (threadReqTab.threadRecImgFlag = "recon"){
	   		threadReqTab.threadRecImgFlag = "null"   
	        close()
	        connect(threadReqTab.remoteIP)  
	   }else {
	   	//		..io.print(832, "threadReqTab.threadRecImgFlag", threadReqTab.threadRecImgFlag)
	   	//		sleep(300)
	   			
	   	//		var	nowTime = time.now()
			//	nowTime.format="%H%M%S";
			//	var nowTimeStr = tostring(nowTime) 
				
			//	if (nowTimeStr <= "112636") or (nowTimeStr >= "113042")
			//	{		
			//		threadReqTab.threadRecImgFlag = "hb"
			//	}
	   		
	   }	
	   sleep(300)   
	}
}



gThreadRecImgReqOnceId, gThreadRecImgReqOnceHandle = 0
threadRecImgReqOnce = function()
{
	import thread.table; 
	//import subPrice
	var threadReqTab = thread.table("subPrice")
	
	
	threadReqTab.isYzmOkThread = "0"

	var startTime = ""
	var endTime = ""
	var costTime = ""

	import console
	import io
	import fsys
	import time
	import zeromq
	
	var requester = null;
	var context = null;
	var recvMsg = null;
	var msg = null;
	var recvMsg = null;	
	var hbmsg = zeromq.message("hb")  
	var hbmsgrecv = zeromq.message()  
	
	
	//threadReq.context = context
	//threadReq.recvMsg = recvMsg
	//threadReq.msg = msg
	//threadReq.recvMsg = recvMsg
	//threadReq.hbmsg = hbmsg
	//threadReq.hbmsgrecv = hbmsgrecv

	connect = function(remoteIP){
		..io.print("StartOpenZeromq...", startTime)
			
		context = zeromq.context(1) 
		requester = context.zmq_socket_request() ;
		//threadReq.requester = requester
		//requester.setsockopt(
		
		var	nowTime = time.now()
		nowTime.format="%H%M%S";
		var nowTimeStr = tostring(nowTime) 
		
		if( requester.connect( "tcp://"+remoteIP+":56666" ) ){
			..io.print("imgSvr connect ok 56666")
		}
		

	}	
	
	close = function(){
		//msg.close()
		//recvMsg.close()	
		//requester.close()
		context.term();	
	}	

	sendHeartBeatMsg = function(){
		..io.print(41, "imgCli sendHeartBeatMsg")
		requester.sendMsg(hbmsg)
		requester.recvMsg(hbmsgrecv);
	}
	
	
	recImgStr4 = function(remoteIP, imgFile){
		threadReqTab.isYzmOkThread = "0"
		//..io.open()
		var resultStr = ""
		
		..io.print("")
		..io.print("")
		
		startTime = time.now()
		startTime.format="%H%M%S";
		..io.print("startOpenImg...", startTime)
		
		endTime = time.now()
		endTime.format="%H%M%S";
		
		var imgFile = io.open(imgFile, "rb");
		imgFile.seek("set")	// to set seek 0
		var imgSize = imgFile.size(1) // get size n bytes use param 1
		
		var rawImg = ..raw.malloc(imgSize, 0)		// init rawMem 0
		imgFile.readBuffer(rawImg, imgSize)		// set rawMew by file binary content 
		imgFile.close()
		
		startTime = time.now()
		startTime.format="%H%M%S";
		..io.print("imgOpened...", startTime)
			
		startTime = time.now()
		startTime.format="%H%M%S";

		
		msg = zeromq.message(rawImg, imgSize)
		
		requester.sendMsg(msg)
		//msg.close();
		

		startTime = time.now()
		startTime.format="%H%M%S";
		..io.print("imgSended...", startTime)
		..io.print("untilImgSendedCost", tonumber(startTime)-tonumber(endTime))
		
		endTime = time.now()
		endTime.format="%H%M%S";
		
		recvMsg = zeromq.message()  
		requester.recvMsg(recvMsg);  
		
		// 如果手动设置了，验证码识别标志为 ok ，那么就直接返回 lhcadd
	    if (threadReqTab.isYzmOkThread=="1"){
	    	return ""; 
	    }
		
		resultStr =  recvMsg.getString() 	
		io.print ("recvMsg", resultStr);
		
		startTime = time.now()
		startTime.format="%H%M%S";
		..io.print("imgReceived...", startTime, resultStr)
		..io.print("untilImgReceivedCost", tonumber(startTime)-tonumber(endTime))
		
		..io.print("")
		..io.print("")
	

		threadReqTab.threadRecImgCode4Str = resultStr	
		threadReqTab.isYzmOkThread = "1"  
	    return resultStr; 
	
	}
	
	
	connect(threadReqTab.imgSvrIp)
	

	//threadReqTab.threadRecImgFlag = "hb"
	//var threadFlag = "0"
	..io.print(1019, "threadReqTab.threadRecImgFlag", threadReqTab.threadRecImgFlag)
	if (threadReqTab.threadRecImgFlag = "recimgreq"){
	   	threadReqTab.threadRecImgFlag = "null"    
	   	..io.print(41, "imgCli sendHeartBeatMsg")
	    threadReqTab.threadRecImgCode4Str = recImgStr4(threadReqTab.imgSvrIp, "D:\jppweb\imgcode4.jpg")	                  
	}
	
	close()   
	
}





cliReceiveThread = function(){

		// log module
		var tm = time.now();
		tm.format="%Y%m%d";
		var today = tostring(tm)
		var filename = "/"+today+"-jppweb-price"+".log"
		
		var xfile = io.open(filename,"a+");
		xfile.write("log start...",'\n');
		xfile.flush();
		
		
		xLog = function(logstr){
			var localtime = time.now()
			localtime.format="%H:%M:%S";
			var slocaltime = tostring(localtime)
			
			var _, tm = ::Kernel32.GetSystemTime( localtime )
			slocaltime = string.format("%s.%03i",slocaltime, tm.milliseconds);	
			
			..io.print(slocaltime, logstr);
			
			xfile.write(slocaltime, logstr ,'\n');
			//xfile.flush();	
		}
		
		
		xLogFlush = function(){
			xfile.flush();
		}
		import thread.table	
		var tab = thread.table("subPrice")
		// useNetPrice = bid3Time
		..io.print(1094,"useNetPrice", tab.useNetPrice)
		if (tab.useNetPrice == "y"){
			try{
					
					import zeromq
					import subPrice
					
					
					..io.print(867, "connect hq svr ip", tab.ip)
					subPrice.init(tab.ip)		
					//io.print("thread")
					//var xLog = tab.get("xLog")
					//var xfile = tab.get("xfile")
			
					var i = 0
					while(true){
						//io.print("thread1")
						
						var msg = zeromq.message()
						subClient = subPrice.getSubClient()
						var ret = subClient.recvMsg(msg,1/*_ZMQ_NOBLOCK*/);
						
						
						//var ret = subClient.recv()
						//io.print(ret)
						
						if(ret){
        						var str = ..raw.tostring( msg.getData(),1,msg.getSize())
        						msg.close();
        						//..io.print("cli-thread", str)	
        						tab.lastPrice =  str;
        						
        						if (i % 5 = 0){
        							..io.print("..[net].. get new hqPrice running ...... cli_thread_getlastPrice-"+str)
     								//newform.edit.text = str;
        							xLog("..[net].. get new hqPrice running ...... cli_thread_getlastPrice-"+str)       						
        							xLogFlush()
        						}
						}
						sleep(100)
						i = i + 1
					}
			}
			catch(e){
				..io.print("546-cli-recv",e)
			}
		}
		else {
			..io.print(1141, "get last price from local img")
			getLastPriceByImg = function(){
				import recJppImageOcr
				return  recJppImageOcr.getImgPrice(tab.xImgTopBtnFlagPrice, tab.yImgTopBtnFlagPrice, tab.xImgBtomBtnFlagPrice, tab.yImgBtomBtnFlagPrice);
			}
				
			import thread.table
			

			var tab = thread.table("subPrice")
			
			tab.lastPrice = "1111"  // init lastPrice = 1111
			
		
			
			var i = 0
			while(true){
				var tmpPrice =  getLastPriceByImg();
				
				
				
				
				import string
				if (tmpPrice != null)  and ( tmpPrice != ""){
					tmpPrice = tostring(tonumber(tmpPrice) + 300)
					var slen = string.len(tmpPrice)

					if (slen >= 5)  and (string.sub(tmpPrice,slen-1,slen) == "00")  // 有效行情判断逻辑
        				tab.lastPrice = "p-"+tmpPrice
        		}
        		
        		if (i % 5 = 0){
        			//..io.print("..[local].. get new hqPrice running ...... cli_thread_getlastPrice-"+tab.lastPrice)
        			xLog("..[local]..get hq running..cli_thread_getlastPrice-"+tab.lastPrice)
        			//newform.edit1.text = tab.lastPrice;  //hqlhc
        			xLogFlush()
        		}
			
				sleep(20)
				i = i + 1
			}
	
		}
			
}

cliGetLastPrice = function(){
	import thread.table
	var tab = thread.table("subPrice")
	var tmpPriceStr = "10000"  // init  tmpPriceStr  
	tmpPriceStr = tab.lastPrice
	try{
		var strArr = string.split(tmpPriceStr, "-")
		tmpPriceStr = strArr[2]			
	}
	catch(e){
		tmpPriceStr = "10000"
	}
	
	return  tmpPriceStr; 
}


cliCmdReceiveThread = function(){
			try{
					import thread.table
					import zeromq
					import subPrice
					
					var tab = thread.table("subPrice")
					..io.print(952, "connect cmdSvr (imgsvr) ip", tab.imgSvrIp)
					subPrice.initCmd(tab.imgSvrIp)		
					
					// log module
					var tm = time.now();
					tm.format="%Y%m%d";
					var today = tostring(tm)
					var filename = "/"+today+"-jppweb-cmd"+".log"
					
					var xfile = io.open(filename,"a+");
					xfile.write("log start...",'\n');
					xfile.flush();
					
					
					xLog = function(logstr){
						var localtime = time.now()
						localtime.format="%H:%M:%S";
						var slocaltime = tostring(localtime)
						
						var _, tm = ::Kernel32.GetSystemTime( localtime )
						slocaltime = string.format("%s.%03i",slocaltime, tm.milliseconds);	
						
						xfile.write(slocaltime, logstr ,'\n');
						//xfile.flush();	
					}
					
					xLogFlush = function(){
						xfile.flush();
					}

					while(true){
						//io.print("thread1")
						
						var msg = zeromq.message()
						subClientCmd = subPrice.getSubClientCmd()
						var ret = subClientCmd.recvMsg(msg,1/*_ZMQ_NOBLOCK*/);
						
						
						//var ret = subClient.recv()
						//io.print(ret)
						
						if(ret){
        						var str = ..raw.tostring( msg.getData(),1,msg.getSize())
        						msg.close();
        						..io.print("cli-threadCmd", str)	
        						tab.lastCmd =  str;
        						xLog("cli-threadCmd"+str)
        						
        						if (str != null) and (string.indexOf(str,"ccmd") != null){
   
        							tab.allbid = str	
        							..io.print(915, str)
        						}
        						
        						xLogFlush()
						}
						sleep(100)
					}
			}
			catch(e){
				..io.print("546-cli-cmd-recv",e)
			}	
}



CliReceiveDeamonThread = function(){
	import thread.table
	var tab = thread.table("subPrice")
	..io.print(639, "waitAll(tab.cliReceiveThreadHandle) stop")
	thread.waitAll(tab.cliReceiveThreadHandle)
	..io.print(641, "waitAll(tab.cliReceiveThreadHandle) restart")
	tab.cliReceiveThreadHandle, tab.cliReceiveThreadId = thread.create(cliReceiveThread)
}




xLog("启动行情接收线程")
cliReceiveThreadHandle, cliReceiveThreadId = thread.create(cliReceiveThread)
subThreadTable.cliReceiveThreadHandle = cliReceiveThreadHandle
subThreadTable.cliReceiveThreadId = cliReceiveThreadId
xLog("启动行情接收线程-启动守护进程")
thread.create(CliReceiveDeamonThread)

xLog("启动控制命令接收线程")
thread.create(cliCmdReceiveThread)

xLogFlush()


// create img  rec  req  thread 
//xLog("启动验证码图片发送线程，并等待发送信号")
//threadRecImgReqHandle, threadRecImgReqId = thread.create(threadRecImgReq)





// 从识别的6位结果中根据需求截取 前 中 后  的 4位返回  ###mod
getCode4 = function(vcode, vtype){
	var rCode = vcode
	
	// 长度为4 直接返回
	if string.len(rCode) == 4 {
		return rCode
	}
	else{
		if (vtype = qCode){
			rCode = string.sub(vcode, 1, 4)
			
		}
		else if (vtype = zCode){
			rCode = string.sub(vcode, 2, 5)
		}
		else if (vtype = hCode){
			rCode = string.sub(vcode, 3, 6)
		}
	}
	return  rCode
}



// return  q  z  h

getCodeQzh = function(vtype){

	var qzhCode = "q"
	//var iFlag = 0
	
	//iFlag = string.indexOf(qCode,vtype)

	try{	
		var tmpStr =  tostring(vtype)
		xLog("1280"+qCode+"-"+zCode+"-"+hCode)
		xLog("getCodeQzh:"+tmpStr)
		
			if (string.indexOf(qCode,tmpStr) !=null){
				xLog("识别码为：前")
				qzhCode = "q"
			}	
			else if (string.indexOf(hCode,tmpStr) !=null){
				xLog("识别码为：后")
				qzhCode = "h"	
			}
			else if (string.indexOf(zCode,tmpStr) !=null){  
				xLog("识别码为：中")
				qzhCode = "z"
			}
			else {
				xLog("识别码为：其他")	
				qzhCode = "n"	
			}
			
			
	}
	catch(e){
		xLog("识别码比对失败，返回:前"+e)	
	}	

	
	return  qzhCode
}



localtime = time.now()
localtime.format="%H:%M:%S";
slocaltime = tostring(localtime)

xLog("程序启动，记录当前时间"+slocaltime);




// 授权校验模块
authTime = "20150816"
try{
	//netTime = time.ntp.getData("ntp.sjtu.edu.cn").time
	netTime.format="%Y%m%d";	
}
catch(e){
	if (isCheckAuth=="1"){
		mainForm.msgboxErr("获取授权失败，请确认网络可以正常连接至 www.alltobid.com")
		mainForm.close()
	}
}

nowTime = time.now()
nowTime.format="%Y%m%d";

if (tostring(netTime) > tostring(authTime)) {
	if (isCheckAuth=="1"){
		mainForm.msgboxErr("当前日期："+tostring(netTime)+"，授权日期为："+authTime+"，当前授权已过期","提示")
		mainForm.close()
	}
}

if (isCheckAuth=="1"){
	mainForm.msgbox("当前日期："+tostring(netTime)+"，授权日期为："+authTime)
}



updateVarCfg2Edt = function(){
	 mainForm.edit2.text =f1Price
	 mainForm.edit4.text =f6Price
	 mainForm.edit6.text =startTimeStr
	 mainForm.edit7.text =endTimeStr
	 mainForm.edit9.text =bidTimeStr
	 
	 
	 mainForm.edit10.text =qCode
	 mainForm.edit11.text =zCode
	 mainForm.edit12.text =hCode
	 mainForm.edit17.text =bpCode
	
	 mainForm.edit13.text =login1TimeStr
	 mainForm.edit14.text =bid1TimeStr
	 mainForm.edit15.text =bid2TimeStr 
	 
	 mainForm.edit16.text =lowestPriceJS
}


updateCfg2Var = function(){
	setVarFromIni()
	updateVarCfg2Edt()
}

// 更新配置到界面变量
xLog("重新读取配置文件，并更新内部变量和界面输入框")
updateCfg2Var()

//重新加载配置
mainForm.button2.oncommand = function(id,event){
	//mainForm.msgbox( mainForm.button2.text );
	//setVarFromIni()
	updateCfg2Var()		
}

// 更新界面变量到配置
mainForm.edit2.oncommand = function(id,event){
	//mainForm.msgbox( mainForm.edit2.text );
	f1Price = mainForm.edit2.text
	secSys.f1Price = f1Price
	secSys.save()
}

mainForm.edit4.oncommand = function(id,event){
	//mainForm.msgbox( mainForm.edit4.text );
	f6Price = mainForm.edit4.text
	secSys.f6Price = f6Price
	secSys.save()	
	
}

mainForm.edit6.oncommand = function(id,event){
	//mainForm.msgbox( mainForm.edit6.text );	
	startTimeStr = mainForm.edit6.text
	secSys.startTimeStr = startTimeStr
	secSys.save()		
}

mainForm.edit7.oncommand = function(id,event){
	//mainForm.msgbox( mainForm.edit6.text );	
	endTimeStr = mainForm.edit7.text
	secSys.endTimeStr = endTimeStr
	secSys.save()	
	
}

mainForm.edit9.oncommand = function(id,event){
	//mainForm.msgbox( mainForm.edit6.text );	
	bidTimeStr = mainForm.edit9.text
	secSys.bidTimeStr = bidTimeStr
	secSys.save()	
	
}


mainForm.edit13.oncommand = function(id,event){
	//mainForm.msgbox( mainForm.edit6.text );	
	login1TimeStr = mainForm.edit13.text
	secSys.login1TimeStr = login1TimeStr
	secSys.save()	
	
}


mainForm.edit14.oncommand = function(id,event){
	//mainForm.msgbox( mainForm.edit6.text );	
	bid1TimeStr = mainForm.edit14.text
	secSys.bid1TimeStr = bid1TimeStr
	secSys.save()	
	
}


mainForm.edit15.oncommand = function(id,event){
	//mainForm.msgbox( mainForm.edit6.text );	
	bid2TimeStr = mainForm.edit15.text
	secSys.bid2TimeStr = bid2TimeStr
	secSys.save()	
	
}

mainForm.hbtn.oncommand = function(id,event){
	//mainForm.msgbox( mainForm.hbtn.text );
	hCode = mainForm.edit5.text+","+hCode
	secSys.hCode = hCode
	secSys.save()
	updateVarCfg2Edt()
}


mainForm.button13.oncommand = function(id,event){
	//mainForm.msgbox( mainForm.hbtn.text );
	bpCode = mainForm.edit5.text+","+bpCode
	secSys.bpCode = bpCode
	secSys.save()
	updateVarCfg2Edt()
}

mainForm.zbtn.oncommand = function(id,event){
	zCode = mainForm.edit5.text+","+zCode
	secSys.zCode = zCode
	secSys.save()
	updateVarCfg2Edt()
}

mainForm.Qbtn.oncommand = function(id,event){
	//mainForm.msgbox( mainForm.Qbtn.text );
	qCode = mainForm.edit5.text+","+qCode
	secSys.qCode = qCode
	secSys.save()
	updateVarCfg2Edt()
}







// 键盘钩子
import key.hook;

hk=key.hook()

// 点击 +300 按钮
clkAdd300 = function(){
	import mouse
	mouse.click(xPrice300, yPrice300,true); 
}

// 点击 提交出价 按钮， 并移动鼠标到 确认 按钮
clkBidBtn300 = function(){
	import mouse
	mouse.click( xPriceBtn, yPriceBtn,true); 
	mouse.move( xConfirmBtn, yConfirmBtn,true); 
}


// 点击 确认 按钮
clkBidConfirm300 = function(){
	import mouse
	mouse.click( xConfirmBtn, yConfirmBtn,true); 
}

// 点击 取消 按钮
clkBidCancel300 = function(){
	import mouse
	mouse.click( xCancelBtn, yCancelBtn,true); 
}

// 点击提示框 确认 按钮
clkErrWndBtn300 = function(){
	import mouse
	mouse.click( xErrorBtn, yErrorBtn,true); 
}


getBidPriceDirectly = function(){
		
}


setBidPriceDirectly = function(inPrice){

	import mouse
	mouse.clickDb(xPriceEdt,yPriceEdt,true)	
	win.delay(10)
	key.press(0x8/*_VK_BACK*/)
	win.delay(10)
    import key
    //key.send(string.sub()
    //key.send(f1Price,2)

    import win.clip
    key.combine("CTRL","a")
    win.delay(20) 
	win.clip.write(inPrice)
    win.delay(20)
    key.combine("CTRL","v")
    
    win.delay(10)	
    curBidPriceStr = inPrice	
}



//默认出价
strPrice = 80000

curBidPriceStr = "10000"
curBidPriceNum = 10000



getCurBidPrice = function(){
	import mouse
	mouse.click(xPriceEdt,yPriceEdt,true)
	win.delay(50)
	xLog("双击出价输入框取到实际出价价格")
    import key
    key.combine("CTRL","a")
    key.combine("CTRL","a")
    win.delay(100)
    key.combine("CTRL","c")
    key.combine("CTRL","c")
    win.delay(50)
    
    
    import win.clip
    curBidPriceStr = win.clip.read()  
    
	try{
		curBidPriceStr = tostring(curBidPriceStr)
	}
		catch(e){
		curBidPriceStr = "100"
	}
	
	
	if (string.len(curBidPriceStr) >  4) 
	{
		return curBidPriceStr;
	}
    	    
    
    var timeout = 0
    while (1)
    {  	
    	if (timeout>3000)
    		break ;
    		
    		
    
    	mouse.click(xPriceEdt,yPriceEdt,true)
		win.delay(50)
		xLog(" 重新取！！！双击出价输入框取到实际出价价格")
    	//import key
    	key.combine("CTRL","a")
    	win.delay(50)
    	key.combine("CTRL","c")
    	win.delay(50)
    	curBidPriceStr = win.clip.read()  
    	
    	try{
    		curBidPriceStr = tostring(curBidPriceStr)
    	}
    	catch(e){
    		curBidPriceStr = "100"
    	}
    	
    	
    	if (string.len(curBidPriceStr) >  4) 
    	{
    		break ;
    	}
    	  
    	
    	timeout = timeout + 150
    }
    
    xLog("1545-！！！！！！！！！实际出价！！！！"+curBidPriceStr)
 	return curBidPriceStr; 
}

// 设置 出价 价格
setPrice = function(stepPrice){
	import mouse
	mouse.clickDb(xPriceEdt,yPriceEdt,true)
	//sleep(50)
	
    import key
    key.combine("CTRL","a")
    win.delay(20)
    key.combine("CTRL","c")
    win.delay(20)
    
    import win.clip
    strPrice = win.clip.read()
    nowPrice = strPrice
    
    try{
    	strPrice = tostring(tonumber(strPrice) + stepPrice)
    }
    catch(e){
    	strPrice = "82900"
    }
    
	win.clip.write(strPrice)
	curBidPriceStr = strPrice
    win.delay(20)
    //key.pressEx("CTRL","v")
    mouse.clickDb( xPriceEdt, yPriceEdt,true); 
    key.combine("CTRL","a")
    win.delay(20)
    key.combine("CTRL","v")
    //key.send(strPrice)
    win.delay(20)
}

gCode4 = ""
setImgCode = function(code4){
	import mouse
	mouse.clickDb( xImgEdt, yImgEdt,true); 
	sleep(50)
	//mouse.click( xImgEdt, yImgEdt,true); 
	
	import key
	key.combine("CTRL","a")
	
	import win.clip
	win.clip.write(string.sub(code4, 1, 4))
    //sleep(2000)
    key.combine("CTRL","v")
    
    gCode4 = code4
    //key.send(string.sub(code4, 1, 4))
}

gSetImgCode6 = ""
setImgCode6 = function(code4){
	import mouse
	mouse.clickDb( xImgEdt, yImgEdt,true); 
	sleep(500)
	//mouse.click( xImgEdt, yImgEdt,true); 
	
	import key
	key.combine("CTRL","a")
	
	import win.clip
	win.clip.write(string.sub(code4, 1, 6))
    sleep(50)
    key.combine("CTRL","v")
    
    gSetImgCode6 = code4
    //key.send(string.sub(code4, 1, 4))
}


getMunalYzm = function(){
	import mouse
	win.delay(20)		
	mouse.clickDb(xImgEdt, yImgEdt,true)
	win.delay(20)
	
	import key
	key.combine("CTRL","a")
	win.delay(20)
	key.combine("CTRL","c")
	win.delay(20)
	
	import win.clip
	var mYzm = win.clip.read()
	return mYzm; 
}


var pixLastPrice;
import com.picture
import tesseract	
	
// 1. 初始化图片识别对象
var ocr = tesseract.ocr();
if( 0 != ocr.init("eng","/res" ) ){ //初始化样本语言包 
	var prefix = win.getenv("TESSDATA_PREFIX");
	if(!#prefix) prefix = "\lib\tesseract\.res\"
	error("没有找到样本 " + prefix + "eng.traineddata",2)
}

//预设字符集可提升识别率，注意要一定在加载样本以后调用此函数
ocr.setVariable("tessedit_char_whitelist","1234567890");

function getCode6ToImgFile(varRange=""){

	xImgTopBtn = secSys.xImgTopBtn
	yImgTopBtn = secSys.yImgTopBtn
	
	xImgBtomBtn = secSys.xImgBtomBtn
	yImgBtomBtn = secSys.yImgBtomBtn
	
	
	xImgTopBtnFlag = secSys.xImgTopBtnFlag
	yImgTopBtnFlag = secSys.yImgTopBtnFlag
	
	xImgBtomBtnFlag = secSys.xImgBtomBtnFlag
	yImgBtomBtnFlag = secSys.yImgBtomBtnFlag
	
	// 截屏前点击下验证码
	import mouse
	mouse.click( xImgTopBtn+10, yImgTopBtn+10,true); 
	
	win.delay(200)
	
	mouse.click(xImgBtomBtn-10, yImgBtomBtn-10, true);
	win.delay(300)
	mouse.click(xImgBtomBtn-10, yImgBtomBtn-10, true);
	
	mouse.move(0, 0, true);
	mouse.click(xImgEdt, yImgEdt, true);
	
    // 把验证码截屏，保存成本地图片    925, 290    975   310
    var picLastPrice = null
    if (varRange == "")
    {
		picLastPrice = com.picture.snap(0, xImgTopBtn,yImgTopBtn , xImgBtomBtn-xImgTopBtn,yImgBtomBtn-yImgTopBtn);
	}
	else {
		picLastPrice = com.picture.snap(0, xImgTopBtn,yImgTopBtn , xImgBtomBtn-xImgTopBtn,(yImgBtomBtn-yImgTopBtn)*2);	
	}
	
	//picLastPrice.Type = 1
	
	//import gdip
	//var bmp =  gdip.bitmap(picLastPrice);
	//bmp.save("D:\jppweb\imgcode6gdip.jpg",100)
	//bmp.save("D:\jppweb\imgcode6gdip80.jpg",80)
	picLastPrice.Save("D:\jppweb\imgcode6.jpg");		

}


//getCode6ToImgFile()

 //  获取  验证码 辅助 说明 图像识别结果
function getImgSbm(varRange = ""){	
	
	xLog("@开始获取识别码")
	xImgTopBtnFlag = secSys.xImgTopBtnFlag
	yImgTopBtnFlag = secSys.yImgTopBtnFlag
	
	xImgBtomBtnFlag = secSys.xImgBtomBtnFlag
	yImgBtomBtnFlag = secSys.yImgBtomBtnFlag

	
    // 把验证码截屏，保存成本地图片    925, 290    975   310
    var picLastPrice = null
    
    if (varRange == "")
    {
		picLastPrice = com.picture.snap(0, xImgTopBtnFlag,yImgTopBtnFlag , xImgBtomBtnFlag-xImgTopBtnFlag,yImgBtomBtnFlag-yImgTopBtnFlag);
	}
	else {
		picLastPrice = com.picture.snap(0, xImgTopBtnFlag-50,yImgTopBtnFlag-5 , xImgBtomBtnFlag-xImgTopBtnFlag+70,yImgBtomBtnFlag-yImgTopBtnFlag+5);	
	}
	
	picLastPrice.Save("d:\jppweb\imgSbm.jpg");		
	
	
	/*
	//获取图像像素数据
	pixLastPrice = liblept.pixRead("d:\jppweb\imgSbm.jpg");	
	ocr.setImage2( pixLastPrice );	
	
	//识别图像
	if( 0 != ocr.recognize() ){
		..io.print(1226,"识别图像出错");
		return "";
	}
	var result = ocr.getText(); 	
	
	try{
		num = tonumber(result)
	}
		catch(e){	
	}
	result = string.trim(result)
	result = string.replace(result," ","")
	xLog("完成获取识别码："+result)
	
	return  result; 
	*/
	return "";
}



 //  获取  验证码 辅助 说明 图像识别结果
function getImgSbmNice(){	
	
	xLog("@开始获取识别码")
	xImgTopBtnFlag1 = 675
	yImgTopBtnFlag1 = 410
	
	xImgBtomBtnFlag1 = 710
	yImgBtomBtnFlag1 = 425

	
    // 把验证码截屏，保存成本地图片    925, 290    975   310
	var picLastPrice = com.picture.snap(0, xImgTopBtnFlag1,yImgTopBtnFlag1 , xImgBtomBtnFlag1-xImgTopBtnFlag1,yImgBtomBtnFlag1-yImgTopBtnFlag1);
	picLastPrice.Save("d:\jppweb\imgSbmBP.jpg");		
	
	//获取图像像素数据
	pixLastPrice = liblept.pixRead( "d:\jppweb\imgSbmBP.jpg" );	
	ocr.setImage2( pixLastPrice );	
	
	//识别图像
	if( 0 != ocr.recognize() ){
		..io.print(1226,"识别图像出错");
		return "";
	}
	var result = ocr.getText(); 	
	try{
		num = tonumber(result)
	}
		catch(e){	
	}
	result = string.trim(result)
	result = string.replace(result," ","")
	xLog("完成获取识别码："+result)
	return  result; 
}




function getImgPriceHigh(){	
	
	xImgTopBtnFlagPrice = secSys.xImgTopBtnFlagPrice
	yImgTopBtnFlagPrice = secSys.yImgTopBtnFlagPrice
	
	xImgBtomBtnFlagPrice = secSys.xImgBtomBtnFlagPrice
	yImgBtomBtnFlagPrice = secSys.yImgBtomBtnFlagPrice

	
    // °??é?¤?????á￡?±￡′?3é±?μ?í???    925, 290    975   310
	var picLastPrice = com.picture.snap(0, xImgTopBtnFlagPrice,yImgTopBtnFlagPrice ,
	 xImgBtomBtnFlagPrice-xImgTopBtnFlagPrice,yImgBtomBtnFlagPrice-yImgTopBtnFlagPrice);
	picLastPrice.Save("/imgPrice.jpg");		
	
	//??è?í???????êy?Y
	pixLastPrice = liblept.pixRead( ..io.fullpath("\imgPrice.jpg") );	
	ocr.setImage2( pixLastPrice );	
	
	//ê?±eí???
	if( 0 != ocr.recognize() ){
		//console.log(true,"ê?±eí???3?′í");
		return "";
	}

	
	var result = ocr.getText(); 
	
	try{
		num = tonumber(result)
		//if (num < 1000 or num > 9999 )
		//	return  ""; 
	}
	catch(e){
		
	}
	
	result = string.trim(result)
	result = string.replace(result," ","")
	
	return  result; 
}


//subThreadTable = thread.table("subPrice")	
subThreadTable.threadRecImgConsoleFlag = ""
subThreadTable.threadRecImgResult = ""
subThreadTable.threadRecImgJppHandle = 0
subThreadTable.threadRecImgDmtHandle = 0

threadRceImgConsole = function(){

	import thread
	import thread.table
	var subThreadTable	= thread.table("subPrice")	
	var jppTHandle = subThreadTable.threadRecImgJppHandle
	var dmtTHandle = subThreadTable.threadRecImgDmtHandle
	var timeOut = 0	
	while(true){
		if (subThreadTable.threadRecImgConsoleFlag == ""){
			win.delay(10)
		}elseif (subThreadTable.threadRecImgConsoleFlag == "start"){
			win.delay(10)
			timeOut = timeOut + 20	
		}elseif (subThreadTable.threadRecImgConsoleFlag == "end") {
			
			if (subThreadTable.threadRecImgResult != "" )
				xLog("1893--###########threadRceImgConsole ended  break:"+subThreadTable.threadRecImgConsoleFlag)	
				break 
			else {
				win.delay(10)
				timeOut = timeOut + 20
			}
			
		}
		elseif (subThreadTable.threadRecImgConsoleFlag == "mend") {
			break ;		
		}
		
		if (timeOut > 1000*60*5){
			xLog("1905--###########threadRceImgConsole ended,!!!!really timeout > 40000!!!!!###"+timeOut)
			break ;
		}
		
		win.delay(10)	
	}
	
	if (subThreadTable.threadRecImgConsoleFlag == "mend")
	{
		//设置手动标识，接受到管理端发送的自动出价命令后，不再进行任何处理
		subThreadTable.manualFlag = "1"
		subThreadTable.threadRecImgResult = getMunalYzm()
		
		xLog("1939-$$$$ getMunalYzm:"+subThreadTable.threadRecImgResult)
	}	
	
	
	xLog("1912-###########  threadRceImgConsole ended,cost Time="+timeOut)
	//xFlush()
	try{
		xLog("1916-$$$$  --- Kill Jpp Thread subThreadTable.threadRecImgJppHandle:")
		thread.terminate(subThreadTable.threadRecImgJppHandle,0)
		//thread.terminate(subThreadTable.threadRecImgDmtHandle,0)	
	}
	catch(e){
		subThreadTable.threadRecImgConsoleFlag = ""
		..io.print("1920 - threadRceImgConsole kill JPP thread error",e)	
	}	
	
	
	try{
		//thread.terminate(subThreadTable.threadRecImgJppHandle,0)
		xLog("1928-$$$$  --- Kill DMT Thread subThreadTable.threadRecImgDmtHandle:")
		// thread.terminate(subThreadTable.threadRecImgDmtHandle,0)	
	}
	catch(e){
		subThreadTable.threadRecImgConsoleFlag = ""
		..io.print("1931 - threadRceImgConsole kill DMT thread error",e)	
	}		
	
	subThreadTable.threadRecImgConsoleFlag = ""	 
}


threadRecImgJpp = function(){	
	import thread
	import thread.table
	var subThreadTable	= thread.table("subPrice")	
	
	
	threadRecImgReq4Jpp = function()
	{
	import thread
	import thread.table; 
	//import subPrice
	var threadReqTab = thread.table("subPrice")
	
	
	threadReqTab.isYzmOkThread = "0"

	var startTime = ""
	var endTime = ""
	var costTime = ""

	import console
	import io
	import fsys
	import time
	import zeromq
	
	var requester = null;
	var context = null;
	var recvMsg = null;
	var msg = null;
	var recvMsg = null;	
	var hbmsg = zeromq.message("hb")  
	var hbmsgrecv = zeromq.message()  
	
	
	//threadReq.context = context
	//threadReq.recvMsg = recvMsg
	//threadReq.msg = msg
	//threadReq.recvMsg = recvMsg
	//threadReq.hbmsg = hbmsg
	//threadReq.hbmsgrecv = hbmsgrecv

	jconnect = function(remoteIP){
		..io.print("StartOpenZeromq...", startTime)
			
		context = zeromq.context(1) 
		requester = context.zmq_socket_request() ;
		//threadReq.requester = requester
		//requester.setsockopt(
		
		var	nowTime = time.now()
		nowTime.format="%H%M%S";
		var nowTimeStr = tostring(nowTime) 
		
		if( requester.connect( "tcp://"+remoteIP+":56666" ) ){
			..io.print("imgSvr connect ok 56666")
		}
		

	}	
	
	jclose = function(){
		//msg.close()
		//recvMsg.close()	
		//requester.close()
		context.term();	
	}	

	jsendHeartBeatMsg = function(){
		..io.print(41, "imgCli sendHeartBeatMsg")
		requester.sendMsg(hbmsg)
		requester.recvMsg(hbmsgrecv);
	}
	
	
	jrecImgStr4 = function(remoteIP, imgFile){
		threadReqTab.isYzmOkThread = "0"
		//..io.open()
		var resultStr = ""
		
		..io.print("")
		..io.print("")
		
		startTime = time.now()
		startTime.format="%H%M%S";
		..io.print("startOpenImg...", startTime)
		
		endTime = time.now()
		endTime.format="%H%M%S";
		
		var imgFile = io.open(imgFile, "rb");
		imgFile.seek("set")	// to set seek 0
		var imgSize = imgFile.size(1) // get size n bytes use param 1
		
		var rawImg = ..raw.malloc(imgSize, 0)		// init rawMem 0
		imgFile.readBuffer(rawImg, imgSize)		// set rawMew by file binary content 
		imgFile.close()
		
		startTime = time.now()
		startTime.format="%H%M%S";
		..io.print("imgOpened...", startTime)
			
		startTime = time.now()
		startTime.format="%H%M%S";

		
		msg = zeromq.message(rawImg, imgSize)
		
		requester.sendMsg(msg)
		//msg.close();
		

		startTime = time.now()
		startTime.format="%H%M%S";
		..io.print("imgSended...", startTime)
		..io.print("###Jpp untilImgSendedCost", tonumber(startTime)-tonumber(endTime))
		
		endTime = time.now()
		endTime.format="%H%M%S";
		
		recvMsg = zeromq.message()  
		requester.recvMsg(recvMsg);  
		
		// ¨¨?1?¨o???￥¨|¨¨??¨￠??ê??¨|??è??¨o??àe?à¨o???a ok ?ê???????¨a??à?¨??¤|ì?? lhcadd
	   // if (threadReqTab.isYzmOkThread=="1"){
	    //	return ""; 
	   // }
		
		resultStr =  recvMsg.getString() 	
		io.print ("recvMsg", resultStr);
		
		startTime = time.now()
		startTime.format="%H%M%S";
		..io.print("imgReceived...", startTime, resultStr)
		..io.print("###Jpp untilImgReceivedCost", tonumber(startTime)-tonumber(endTime))
		
		..io.print("")
		..io.print("")
	

		threadReqTab.threadRecImgCode4Str = resultStr	
		
		threadReqTab.threadRecImgResult = resultStr 
		subThreadTable.threadRecImgConsoleFlag = "end"
		//threadReqTab.isYzmOkThread = "1"  
	    return resultStr; 
	
	}
	
	jconnect(threadReqTab.imgSvrIp)
	
	var resultStr4 = jrecImgStr4(threadReqTab.imgSvrIp, "D:\jppweb\imgcode4.jpg")	  
	
	..io.print("2086-###JPP resultStr4" , resultStr4)   
	..io.print("2088-###!!!!!!!!!!#########Jpp Thread Result :"+subThreadTable.threadRecImgResult)
	            	
	jclose()   
	return  resultStr4; 
}

		
	subThreadTable.threadRecImgResult = threadRecImgReq4Jpp()	
	
	
}

threadRecImgDmt = function(){


	import thread
	import thread.table
	var subThreadTable	= thread.table("subPrice")		
	//subThreadTable.threadRecImgResult = "***************************************************************************************" 

	// 加载打码兔 dll
	var dll = raw.loadDll( "\jppweb.dll" );  // ′ò??í?
	var dmtDecodeByImg = dll.api( "D2File","int (string id, string name, string pwd, string file, int timeout, int type, string vcode)", "stdcall" ); 


	dmtDecode4 = function(imgPath){
		import thread
		import thread.table
		var subThreadTable	= thread.table("subPrice")	
		//subThreadTable.threadRecImgResult = "***************************************************************************************" 
		var gcode4dmt = "--------"
		try{
			err = dmtDecodeByImg("d5d65fa8b386642d778055207eb09bf3",  "kaka21", "!@#$qwer", 
 			imgPath, 
 			40,  4,  gcode4dmt)	
		}
		catch(e){
			
		}
 		
 		..io.print("2127--############!!!!!!!Thread DMT gcode4dmt:", gcode4dmt)		
		if (err < 0){
			..io.print("err", err)	
			gcode4dmt = ""
		}
		
		var dmtResStr = ""
		try{
			import string
			dmtResStr = string.replace(gcode4dmt,"-", "")
			..io.print("2137--############!!!!!!!Thread DMT dmtResStr:", dmtResStr)		
			string.trim(dmtResStr)
			
			dmtResStr = string.sub(dmtResStr, 1, 4)
			
			if (dmtResStr == "IERR") {   // IERROR
				dmtResStr = ""
			} 
			
			

		}
		catch(e){
			..io.print("2140--dmt to number ERROR:", dmtResStr)		
			dmtResStr = ""
		}
		 
		
		
		
		//string.replace(
		..io.print("2138--############!!!!!!!---dmtResStr:", dmtResStr)
		
		return dmtResStr, err
	}

	import thread
	import thread.table
	var subThreadTable	= thread.table("subPrice")		
	 var tmpdmt4 = dmtDecode4("D:\jppweb\imgcode4.jpg")
	 
	 if (subThreadTable.threadRecImgResult == "") 
	 {
	 	subThreadTable.threadRecImgResult = tmpdmt4
	 }
	
	if (subThreadTable.threadRecImgResult != ""){
	  	..io.print("### DMT SET threadRecImgConsoleFlag  END !!!")
		subThreadTable.threadRecImgConsoleFlag = "end"
	}
	//..io.print("###Dmt:"+subThreadTable.threadRecImgResult)
	..io.print("2165 relust ###!!!!!!!!!!#########DMT Thread Result :"+subThreadTable.threadRecImgResult)
}



startThreadRecImg = function(varYzmType){
	import thread
	import thread.table
	var subThreadTable	= thread.table("subPrice")	
	

	subThreadTable.threadRecImgJppHandle = thread.create(threadRecImgJpp)
	if (varYzmType == "all"){
		// subThreadTable.threadRecImgDmtHandle = thread.create(threadRecImgDmt)
	}
	
	//xLog("2204-jppThread:"+subThreadTable.threadRecImgJppHandle)
	//xLog("2205-dmtThread:"+subThreadTable.threadRecImgDmtHandle)
	
	try{
		subThreadTable.threadRecImgConsoleFlag = "start"
		//thread.create(threadRceImgConsole)	
		threadRceImgConsole()
	}
	catch(e){
		subThreadTable.threadRecImgConsoleFlag = ""
		xLog(e)	
	}
	
}



threadSendMsgToMgrSvr = function(){
	
	//客户端
	import zeromq
	import thread
	import thread.table
	
	
	var tab = thread.table("subPrice")
	

	
	var context = zeromq.context(10) 
	//request模式socket与服务端的reply模式配对使用
	var requester = context.zmq_socket_request() ;
	
	//requester.connect( "tcp://localhost:5559" )
	
	
	//connect(tab.imgSvrIp)
	
	if( requester.connect( "tcp://"+tab.imgSvrIp+":51111" ) ){
    	..io.print("threadSendMsgToMgrSvr-连接成功")
	}
	
	var msg = zeromq.message(tab.clientIp)  
	requester.sendMsg(msg)
	msg.close();
	
	var reply = zeromq.message()  
	requester.recvMsg(reply);  
	..io.print ("threadSendMsgToMgrSvr-客户端收到消息 ", reply.getString() );
	reply.close()
	
	context.term(); 
	
}



pressF1 = function(){
	xLog("@加自定义价格进行出价")
	xLog("设置自定义加价价格")
	
	if (subThreadTable.threadRecImgResult != "1111") or (subThreadTable.threadRecImgResult != "y")
	{
		setCustomAddPriceEdtValue()
		isYzmOk = "0"
		
		xLog("点击自定义加价按钮")
		clkCustomAddPriceBtn()
	}
	//clkAdd300()  // clk + 300
	win.delay(10)	
	
	xLog("获取实际出价价格，用来与行情进行比较")
	getCurBidPrice()
	xLog("###	实际出价，["+getNowTime()+"] curBidPriceStr："+curBidPriceStr)
	xLogFlush()
	//setPrice(f1Price)   // add 200 
	win.delay(10)	
	
	xLog("点击出价按钮")
	clkBidBtn300() // clk  bid btn
	
	//demo
	//import mouse
	//mouse.click( 845, 559,true); 
	//end demo	
	//mouse.move(0,0,true)
}




pressF1Tmp = function(varBidPrice){
	xLog("@直接价格进行出价")
	xLog("设置直接出价价格")
	
	if (subThreadTable.threadRecImgResult != "1111") or (subThreadTable.threadRecImgResult != "y")
	{
		//setCustomAddPriceEdtValue()
		isYzmOk = "0"
		
		xLog("设置直接出价价格")
		//clkCustomAddPriceBtn()
		setCustomBidPriceEdtValueNice(varBidPrice)
	}
	//clkAdd300()  // clk + 300
	win.delay(10)	
	
	xLog("获取实际出价价格，用来与行情进行比较")
	getCurBidPrice()
	xLog("###	实际出价，["+getNowTime()+"] curBidPriceStr："+curBidPriceStr)
	xLogFlush()
	//setPrice(f1Price)   // add 200 
	win.delay(10)	
	
	xLog("点击出价按钮")
	clkBidBtn300() // clk  bid btn
	
	//demo
	//import mouse
	//mouse.click( 845, 559,true); 
	//end demo	
	//mouse.move(0,0,true)
}



pressF1Nice = function(addPrice){
	xLog("@加自定义价格进行出价")
	xLog("设置自定义加价价格")
	setCustomAddPriceEdtValueNice(addPrice)
	isYzmOk = "0"
	
	xLog("点击自定义加价按钮")
	clkCustomAddPriceBtn()
	//clkAdd300()  // clk + 300
	win.delay(10)	
	
	xLog("获取实际出价价格，用来与行情进行比较")
	getCurBidPrice()
	xLog("###	实际出价，["+getNowTime()+"] curBidPriceStr："+curBidPriceStr)
	xLogFlush()
	//setPrice(f1Price)   // add 200 
	win.delay(10)	
	
	xLog("点击出价按钮")
	clkBidBtn300() // clk  bid btn
	
	//demo
	//import mouse
	//mouse.click( 845, 559,true); 
	//end demo	
	//mouse.move(0,0,true)
}



pressF1Nice2 = function(varBidPrice){
	xLog("@加自定义价格进行出价")
	xLog("设置自定义加价价格")
	//setCustomAddPriceEdtValueNice(addPrice)
	
	setCustomBidPriceEdtValueNice(varBidPrice)
	
	isYzmOk = "0"
	
	//xLog("点击自定义加价按钮")
	//clkCustomAddPriceBtn()
	//clkAdd300()  // clk + 300
	win.delay(10)	
	
	xLog("获取实际出价价格，用来与行情进行比较")
	getCurBidPrice()
	xLog("###	实际出价，["+getNowTime()+"] curBidPriceStr："+curBidPriceStr)
	xLogFlush()
	//setPrice(f1Price)   // add 200 
	win.delay(10)	
	
	xLog("点击出价按钮")
	clkBidBtn300() // clk  bid btn
	
	//demo
	//import mouse
	//mouse.click( 845, 559,true); 
	//end demo	
	//mouse.move(0,0,true)
}


isBidPageNice = function(){

	xLog("###	判断是否出价主页"）
	
	var sbmTimeOut = 0
	while(true){
		var vtype = getImgSbmNice()
		
		xLog("###	bpCode:"+bpCode+"实际取值："+vtype）
		
		clkErrWndBtn300()	
		
		if (vtype != "") and (string.indexOf(bpCode, vtype)!=null) {
			break;
		}
		
		sbmTimeOut = sbmTimeOut + 200
		win.delay(200)
		
		if (sbmTimeOut > 1600){  // 2秒超时
			xLog("###	判断是否出价主页超时["+getNowTime()+"] sbmTimeOut:"+tostring(sbmTimeOut))
			break;
		}
	}				
			
}




pressF1Patch = function(){
	//setCustomAddPriceEdtValue()
	xLog("@最新最高价+补加"+priceBefore+"进行出价")
	isYzmOk = "0"
	
	//clkCustomAddPriceBtn()
	xLog("点击加300加价按钮")
	clkAdd300()  // clk + 300
	win.delay(10)	
	
	xLog("获取实际出价价格，用来与行情进行比较")
	setPrice(priceBefore)   // add 200 
	win.delay(10)
	getCurBidPrice()
	win.delay(10)	
	xLog("点击出价按钮@")
	clkBidBtn300() // clk  bid btn	
	// demo
	//import mouse
	//mouse.click( 845, 559,true); 	
	//mouse.move(0,0,true)
}




pressF1300 = function(){
	//setCustomAddPriceEdtValue()
	xLog("@加300进行出价")
	isYzmOk = "0"
	
	//clkCustomAddPriceBtn()
	xLog("点击加300加价按钮")
	clkAdd300()  // clk + 300
	win.delay(10)	
	
	xLog("获取实际出价价格，用来与行情进行比较")
	getCurBidPrice()
	//setPrice(f1Price)   // add 200 
	win.delay(10)	
	xLog("点击出价按钮@")
	clkBidBtn300() // clk  bid btn	
	// demo
	//import mouse
	//mouse.click( 845, 559,true); 	
	//mouse.move(0,0,true)
}




pressF3 = function(){	
	xLog("点击确认出价按钮")	
		
	clkBidConfirm300()
	xLog("	##	确认出价完成")
	win.delay(200)
	xLog("点击提示框确认按钮")
	clkErrWndBtn300()		
	xLogFlush()
}

import recImgByRemoteMan


pressF7 = function(varYzmType = "jpp"){
	
	import time
	var t1 = time.now()
	
	mainForm.picturebox2.image = "\qmt.jpg"
	
	var nowTime1 = time.now()
	nowTime1.format="%H%M%S";
	var nowTimeStr1 = tostring(nowTime1) 
	
	..io.print(1510, "start ImgSnap",nowTimeStr1) 
	
	
	// 截屏
	xLog("截取验证码图片，并保存到文件：D:\jppweb\imgcode6.jpg")
	getCode6ToImgFile()
	//snapImg.bakImgFile("imgcode6.jpg")
	
	mainForm.picturebox2.redraw()
	mainForm.picturebox2.image = "D:\jppweb\imgcode6.jpg"
	mainForm.picturebox2.redraw()
	
	
	//gcode = "123456"
	//
	xLog("开始获取识别码sbm")
	//var tmpsbm = getImgSbm()
	//var codeQzh = getCodeQzh(tmpsbm)
	//var tmpcode4 = getCode4(gcode,tmpsbm)
	//xLog("获取识别码完成sbm = "+tmpsbm )

	/*
	if (codeQzh == "n")
	{
		xLog("重新截取验证码图片，并保存到文件：D:\jppweb\imgcode6.jpg")
		getCode6ToImgFile("rangeBy2")
		snapImg.bakImgFile("imgcode6.jpg")
		
		mainForm.picturebox2.redraw()
		mainForm.picturebox2.image = "D:\jppweb\imgcode6.jpg"
		mainForm.picturebox2.redraw()		
	}
	*/	
	
	var code4Result = ""
	
	xLog("合并处理发送验证码图片")
	//if (codeQzh != "n"){
	//	snapImg.snapImgRectFromImgFile("D:\jppweb\imgcode6.jpg", "D:\jppweb\imgcode4.jpg", codeQzh)
	//}	
	// "合并图片和说明"
	//else {//if (codeQzh == "n"){
		getImgSbm("n")
		snapImg.conbineImgRectFromImgFile("d:\jppweb\imgcode6.jpg",	"d:\jppweb\imgsbm.jpg", "D:\jppweb\imgcode4.jpg")	
	//}
	//snapImg.bakImgFile("imgcode6.jpg")
	//snapImg.bakImgFile("imgsbm.jpg")
	//snapImg.bakImgFile("imgcode4.jpg")
	
	
	
	if (varYzmType == "dmt") {
		xLog("dmt发起验证码识别请求")
		//snapImg.snapImgRectFromImgFile("D:\jppweb\imgcode6.jpg", "D:\jppweb\imgcode4.jpg", codeQzh)
		jppDecode4("D:\jppweb\imgcode4.jpg")
		xLog("dmt验证码识别完成")
	}
	else if (varYzmType == "jpp") {
		xLog("jpp发起验证码识别请求")
		//xLog("jpp根据sbm识别码从6位图片中截取4位图片，保存成文件：D:\jppweb\imgcode4.jpg")	
		//snapImg.snapImgRectFromImgFile("D:\jppweb\imgcode6.jpg", "D:\jppweb\imgcode4.jpg", codeQzh)
		//jppDecode4("D:\jppweb\imgcode4.jpg")
		//import recImgByRemoteMan
		import thread
		
		nowTime = time.now()
		nowTime.format="%H%M%S";
		nowTimeStr = tostring(nowTime) 
		
		..io.print("recImgB",nowTimeStr)
		
		xLog("jpp设置验证码识别-线程标识-为开始识别")
		subThreadTable.threadRecImgFlag = "recimgreq"
		gThreadRecImgReqOnceHandle, gThreadRecImgReqOnceId = thread.create(threadRecImgReqOnce)
		var tmpCode4 = ""
		
		//thread.create(threadRecImgReqOnce)
		
		xLog("循环等待识别结果返回")
		var ImgRectimeOut = 0
		while(true)
		{
			// 两种方式设置 isYzmOkThread = 1 ，a. 手动F2设置 tmpCode4 为 ""， b. 验证码识别正常返回 tmpCode4 为 4位字符串
			
			if (subThreadTable.isYzmOkThread = "1")
			{
				tmpCode4 = subThreadTable.threadRecImgCode4Str
				subThreadTable.threadRecImgCode4Str = ""
				subThreadTable.isYzmOkThread = "0"
				break ;	
			}	
			//tmpCode4 = subThreadTable.threadRecImgCode4Str
			//if (threadReqTab.isYzmOkThread = "1") or ((tmpCode4 != null) and (string.len(tmpCode4) > 0)) {	
			//	subThreadTable.threadRecImgCode4Str = ""
			//	break ;
			//}
			else {
				win.delay(50)
				ImgRectimeOut = ImgRectimeOut + 50
			}	
			
			// 10分钟没有识别返回验证码，则超时，返回 y 重新发起验证码识别
			if (ImgRectimeOut > 1000*60*10){
				tmpCode4 = "rerecImg"
				xLog("	!!!	jpp验证码识别超时，重新发起识别, tmpCode4:"+tmpCode4)
				//thread.create(threadRecImgReqOnce)
				import thread
				thread.terminate(gThreadRecImgReqOnceHandle,0)
				xLog("###	!!!jpp验证码识别超时，终止识别线程["+getNowTime()+"] gThreadRecImgReqOnceHandle："+gThreadRecImgReqOnceHandle)
				//threadRecImgReqHandle, threadRecImgReqId = thread.create(threadRecImgReq)
				break;	
			}
		}
		xLog("完成识别，识别结果："+tmpCode4)
		//var tmpCode4 = recImgByRemoteMan.recImgStr4(imgSvrIp, "D:\jppweb\imgcode4.jpg")
		..io.print(1346, "jppRecImg", tmpCode4)
		
		
		if(tmpCode4 == "y") 
		{	
			xLog("根据识别结果 y 进行特殊处理，识别结果："+tmpCode4)
			nowTime = time.now()
			nowTime.format="%H%M%S";
			nowTimeStr = tostring(nowTime) 
			..io.print("recImgE",nowTimeStr)
		
		    win.delay(200)
			clkBidCancel300()
			win.delay(200)
			clkBidConfirm300()
			//pressF1300()
			
			var secDiff = nowTime.diffsecond(t1)
			
			if (secDiff < 5){
				win.delay((5-secDiff)*1000)
			} 
			
			xLog("重新点击出价按钮")
			clkBidBtn300() // clk  bid btn
			
			win.delay(300)
			pressF7(yzmType)	
			return "", "";
		}elseif (tmpCode4 == "rerecImg")  {
			xLog("根据识别结果 rerecImg 进行重新发起验证码识别，识别结果："+tmpCode4)
			pressF7(yzmType)
			return "", "";	
		}
		
		
		gcode = tmpCode4
		if (tmpCode4 != ""){
			code4Result = tmpCode4
		}
		//thread.create(recImgByRemoteMan.recImgStr4, imgSvrIp, "D:\jppweb\imgcode4.jpg")
		xLog("jpp验证码识别完成， 最终识别结果："+gcode)
	}
	else if (varYzmType == "all") or (varYzmType == "allndmt") {
	
		xLog("jpp发起验证码识别请求")
		//xLog("jpp根据sbm识别码从6位图片中截取4位图片，保存成文件：D:\jppweb\imgcode4.jpg")	
		//snapImg.snapImgRectFromImgFile("D:\jppweb\imgcode6.jpg", "D:\jppweb\imgcode4.jpg", codeQzh)
		
		import mouse
		mouse.click( xImgEdt, yImgEdt,true);
	
		// 启动验证码识别线程，可F2 手动结束线程返回验证码，或40秒线程处理超时返回
		startThreadRecImg(varYzmType)
		
		import thread
		import thread.table
		var subThreadTable	= thread.table("subPrice")		
		
		
		code4Result = subThreadTable.threadRecImgResult;
		try{
			code4Result = string.trim(code4Result)
		}
		catch(e){
			code4Result = "1111"
		}
		
		
	}
	else {
		gcode = jppDecode6uuScreen(xImgTopBtn,yImgTopBtn , xImgBtomBtn-xImgTopBtn,yImgBtomBtn-yImgTopBtn)
	}
	
	
	//var tmpcode4 = string.trim(gcode)
	//var tmpcode4 = getCode4(gcode,tmpsbm)
	
	nowTime2 = time.now()
	nowTime2.format="%H%M%S";
	nowTimeStr2 = tostring(nowTime2) 
	
	xLog（"2472-输入验证码识别结果到，输入框"+code4Result)
	if (code4Result != null) {
		if (string.len(code4Result) == 4){
			if (code4Result == "1111")
			{
				
			}	
			else
			{
				setImgCode(code4Result)
				//subThreadTable.threadRecImgResult = "";
			}
		}
		
		import fsys
		xLog("fsys.rename file !!!!!!!!!!!!"+"D:\jppweb\recImgResult\"+nowTimeStr2+"_"+code4Result+".jpg")
		fsys.copy("d:\jppweb\imgcode4.jpg","D:\jppweb\recImgResult\"+nowTimeStr2+"_"+code4Result+".jpg")
		//code4Result = ""
	}
	
	xLog(1510+"end ImgSnap and SetImgCode end all cost:"+nowTimeStr2+":"+tostring(tonumber(nowTimeStr2)-tonumber(nowTimeStr1))) 
	import thread
	
	//request str lhc
	thread.create(threadSendMsgToMgrSvr)
	xLog（"验证码识别并输入完成@")
	gcode = code4Result
	return code4Result, gcode; 	
}





setEdtValue = function( x, y , value){
	import mouse
	mouse.clickDb(x,y,true)	
	win.delay(50)
    import key
    //key.send(string.sub()
    key.send(value,20)
    win.delay(50)		
}

clkBtnValue = function(x, y){
	import mouse
	mouse.click( x, y,true); 	
	mouse.move(0,0,true)
}


setUser = function(){
	..io.print(22, user)
	xLog("输入投标号")
	setEdtValue(xUserEdt, yUserEdt, user)		
}


setPwd = function(){
	..io.print(33, pwd)
	xLog("输入投标密码")
	setEdtValue(xPwdEdt, yPwdEdt, pwd)	
}


function getImgFile(xImgTop, yImgTop, xImgBtom, yImgBtom, imageFile){
	
    // °??é?¤?????á￡?±￡′?3é±?μ?í???    925, 290    975   310
    //import com.picture
	var picLastPrice = com.picture.snap(0, xImgTop,yImgTop , xImgBtom-xImgTop,yImgBtom-yImgTop);
	
	//"D:\jppweb\imgcode6.jpg"
	picLastPrice.Save(imageFile);		
}

setLoginYzm = function(){
	//..io.print(9999,xImgTopLogin, yImgTopLogin, xImgBtomBtnLogin,yImgBtomBtnLogin)
	xLog("发起dmt识别登陆验证码，并完成输入")
	getImgFile(xImgTopLogin, yImgTopLogin, xImgBtomBtnLogin,yImgBtomBtnLogin,"D:\jppweb\loginYzm.jpg")
	//getImgFile(919,459,107,100,"D:\jppweb\loginYzm.jpg")
	jppDecode6Test("D:\jppweb\loginYzm.jpg")
	
	var rcode = string.trim(gcodeTest)
	rcode = string.sub(rcode, 1, 6)
	..io.print(999,string.trim(rcode))
	setEdtValue(xImgLoginEdt, yImgLoginEdt, rcode)	
}

login = function(){
	xLog("点击登陆按钮")
	clkBtnValue(xBtnLogin, yBtnLogin)
	xLogFlush()
}

..io.print(44, user, pwd)


loginOnce = function(){
	setUser()
	setPwd()
	setLoginYzm()
	login()
}

loginAgain = function(){
	setUser()
	setPwd()
	setIdNo()
	setLoginAgainYzm()
	loginAgain()	
}

setBidOncePrice = function(){
	xLog("设置首次出价价格，警示价："+lowestPriceJS+"并点击出价")
	setEdtValue(xBidOnce1Edt, yBidOnce1Edt, lowestPriceJS)	
	setEdtValue(xBidOnce2Edt, yBidOnce2Edt, lowestPriceJS)	
	clkBtnValue(xBidOnceBtn, yBidOnceBtn)		
}


setBidOncePriceGs = function(){
	
	var hqLastPriceStr = cliGetLastPrice()
	xLog("获取最新行情"+hqLastPriceStr)	
	var hqLastPriceNum = tonumber(hqLastPriceStr)
	
	hqLastPriceNum = hqLastPriceNum + 20000
	
	hqLastPriceStr = tostring(hqLastPriceNum)
	
	xLog("设置首次出价价格，警示价："+hqLastPriceStr+"并点击出价")
	setEdtValue(xBidOnce1Edt, yBidOnce1Edt, hqLastPriceStr)	
	setEdtValue(xBidOnce2Edt, yBidOnce2Edt, hqLastPriceStr)	
	clkBtnValue(xBidOnceBtn, yBidOnceBtn)		
}
setbidOnceYzm = function(){	
	//return tmpcode4, gcode; 	
}



bidOnce = function(){
	xLog("@开始首次出价")
	xLog("设置首次出价价格，警示价")
	setBidOncePrice()
	
	// 等待验证码
	win.delay(2000)
	//redo
	pressF7(yzmType)
	
	_Beep(3000, 100)
	
	//###test 
	//setbidOnceYzm()
	
	// 等待
	win.delay(3000)
	pressF3()	
	
	
	win.delay(3000)
	
	// 点击确认按钮
	clkErrWndBtn300()
	xLog("完成首次出价@")
	
}
bidOnceGs = function(){
	xLog("@开始首次出价")
	xLog("设置首次出价价格，警示价")
	setBidOncePriceGs()
	
	// 等待验证码
	win.delay(500)
	//redo
	//pressF7(yzmType)
	
	_Beep(3000, 100)
	
	//###test 
	//setbidOnceYzm()
	
	// 等待
	//win.delay(3000)
	//pressF3()	
	
	
	//win.delay(3000)
	
	// 点击确认按钮
	//clkErrWndBtn300()
	xLog("完成首次出价@")
	
}


pressBidTwice = function(){
	clkAdd300()  // clk + 300
	win.delay(100)	
	setPrice(0)   // add 0 
	win.delay(100)	
	clkBidBtn300() // clk  bid btn
}

bidTwice = function(){
	pressBidTwice()
	
	// 等待验证码
	win.delay(2000)
		//redo
	pressF7(yzmType)
	
	_Beep(3000, 100)
	
	//###test 
	//setbidOnceYzm()
	
	// μè′y
	win.delay(3000)
	pressF3()	
	
	
	win.delay(3000)
	
	// μ??÷è・è?°′?￥
	clkErrWndBtn300()
	
	
}



// 自动登陆 9:30
pressEnter = function(){
	import key
	key.press( "ENTER" )		
}


openLoginPage = function(){
	xLog("@点击浏览器地址栏，进入国拍拍牌页面")
	clkBtnValue(400,50) // 点击地址栏，进入页面
	
	
	
	//key input url  
	import mouse
	mouse.clickDb(400,50,true)	
	win.delay(500)
    import key
    key.combine("CTRL","a")
    //key.send(string.sub()
    win.delay(500)	
    
    // set weburl param 
    key.send("paimai.alltobid.com",50)
    win.delay(500)	
	
	
	// click web go   
	//clkBtnValue(790,50) // 点击地址栏，进入页面
	pressEnter()
	
	xLog("等待10秒，等待页面打开")
	win.delay(10000)
	
	/*
	import math
	math.randomize()
	var tmpDxLtFlag = tostring(math.random(1, 2))
	
	
	
	xLog("随机选择，电信联通线路")
	if (tmpDxLtFlag!=null) and (tmpDxLtFlag=="1") {
		clkBtnValue(569, 430) // 选择电信
	}else {
		clkBtnValue(757, 430) // 选择联通	
	}	
	*/
	
	if (bid1Time!=null) and (bid1Time=="lt") {
		clkBtnValue(757, 430) // 选择联通	
	}else {	
		clkBtnValue(569, 430) // 选择电信
	}
	
	win.delay(5000)
	
	xLog("点击确认拍卖说明按钮")
	clkBtnValue(918,570) // 确认
	win.delay(3000)
	
	xLog("点击同意拍卖说明按钮@")
	clkBtnValue(918,570) // 同意
	win.delay(3000)
}


openLoginPageAll = function(){
	
	xLog("进入国拍网页")
	//startCamPauseRecord()
	win.delay(3000)
	openLoginPage()	
	win.delay(3000)
	//startCamPauseRecord()	
	xLogFlush()
	
}


		
loginOnceAll = function(){
	startCamPauseRecord()
	win.delay(3000)
	loginOnce()	
	win.delay(3000)
	startCamPauseRecord()	
}

	
	// 首次出价  10:32
bidOnceAll = function(){
	startCamPauseRecord()
	win.delay(1000)
	bidOnce()
	win.delay(1000)
	startCamPauseRecord()			
}

	// 首次出价公司  14:29:40 +20000
bidOnceAllGs = function(){
	//startCamPauseRecord()
	//win.delay(1000)
	bidOnceGs()
	//win.delay(1000)
	//startCamPauseRecord()			
}



mainForm.button14.oncommand = function(id,event){
	//mainForm.msgbox( mainForm.button14.text );
	bidOnceAllGs()	
	
}
	
	
// 二次出价  11:02
bidTwiceAll = function(){
	startCamPauseRecord()
	win.delay(3000)
	bidTwice()
	win.delay(3000)
	startCamPauseRecord()	
}


bidFinalAllPatch = function(){
	xLog("@最终出价后，抢补出价")
	
	
	xLog("最终出价后，抢补出价完成@")
}




bidFinalAll = function(varTime = "1"){
	xLog("!!!!	开始最终出价")
	startTime1 = time.now()
	startTime1.format="%H%M%S";
	..io.print("F1 Start...", startTime1)
	
	// 提交出价
	if (varTime == "1")
	{
		pressF1()
	}else {
		//pressF1Patch()
	}
	
	xLog("	##	提交出价")
		
	// 等待验证码， 如果 识别码 不对，应超时跳出，或重取验证码
	xLog("循环等待获取识别码，2秒超时")
	var sbmTimeOut = 0
	while(true){
		/*var vtype = getImgSbm()
		
		if (string.indexOf(qCode, vtype)!=null) {
			break;
		}
		else if (string.indexOf(zCode, vtype)!=null){
			break;
		}
		else if (string.indexOf(hCode, vtype)!=null){
			break;
		}
		*/
		sbmTimeOut = sbmTimeOut + 200
		win.delay(200)
		
		if (sbmTimeOut > 600){  // 2秒后超时
			xLog("###	！！！验证码识别码超时，["+getNowTime()+"] sbmTimeOut："+tostring(sbmTimeOut))
			break;
		}
	}				
		
	xLog("开始发起验证码识别")	
	// 识别验证码并输入
	xLog("###	开始识别验证码，["+getNowTime()+"] 验证码识别类型-yzmType："+yzmType)
	pressF7(yzmType)
	xLog("###	完成识别验证码，["+getNowTime()+"] 验证码识别结果-gCode："+gCode)
	xLog("##	输入验证码完成")
	//mainForm.msgbox(nowTimeStr+"-"+gDoneTimer)
		
	// 提交
	xLog("获取出价价格，并准备与最新行情进行比较，然后提交出价"+curBidPriceStr)	
	try{
		curBidPriceNum = tonumber(curBidPriceStr)
		var curBidPriceNumSub100 = curBidPriceNum - 100
	}
	catch(e)
	{
		..io.print(1899, "curBidPriceNum error !!!!")	
	}
	
	xLog("循环与最新行情进行比较，然后提交出价")	
	while(true){	
	
		//win.delay(20)	
		nowTime = time.now()
		nowTime.format="%H%M%S";
		nowTimeStr = tostring(nowTime) 
		
		
		var hqLastPriceStr = cliGetLastPrice()
		xLog("获取最新行情"+hqLastPriceStr)	
		hqLastPriceNum = tonumber(hqLastPriceStr)

		//if(nowTimeStr<"00:00:10"){ // 未到最后出价时间
		if(nowTimeStr<timeLine){ // 未到最后出价时间
			xLog("未到最后出价时间，行情："+lPriceStr+"，出价："+curBidPriceStr)
			win.delay(25)
			
			..io.print(1730, "curPriceBid:", curBidPriceNum, "hqLastPrice:", hqLastPriceNum)
			
			if (hqLastPriceNum >= curBidPriceNum) { // 如果，目前最高价，大于出价，立即发出
				xLog("###	!!!最高价行情 到达(大于) 实际出价价格，立即出价，行情："+hqLastPriceStr+"，出价："+curBidPriceStr+"行情大于出价")	
				pressF3()
				break;	
			}elseif (hqLastPriceNum >= curBidPriceNumSub100){ // 如果最高价 距离 出价 还有 1个档位，立即出价
				//if 	(nowTimeStr>="112950")	{ // 50秒后，价格还差100，就可以选择出价了
				//	xLog("行情到达出价-100，立即出价，行情："+lPriceStr+"，出价："+curBidPriceStr)	
				//	pressF3()
				//	break;	
				//}
			}
			
			
			
		}else {  // 到了最后出价时间，不管任何情况，选择出价 // 53秒后，不管任何情况都应该出价了
			xLog("###	!!!到达最后出价时间:"+endTimeStr+" 强制出价,，行情："+hqLastPriceNum+"，出价："+curBidPriceStr)
			pressF3()
			break;	
		}
	}	
	
	startTime2 = time.now()
	startTime2.format="%H%M%S";	
	..io.print("bid final all cost :", startTime2, tonumber(startTime2)-tonumber(startTime1))
	
	xLog("!!!!	结束最终出价,	全过程耗时：	"+(tonumber(startTime2)-tonumber(startTime1)))
	xLogFlush()
	
	//thread.create(threadSendMsgToMgrSvr)
	
	if (varTime=="1"){
		
		xLog(" !!!!准备补抢拍!!!!")
		win.delay(4000)	
		clkErrWndBtn300()
		clkErrWndBtn300()	
		
		// 最终出价抢补出价
		nowTime = time.now()
		nowTime.format="%H%M%S";
		nowTimeStr = tostring(nowTime) 
		
		
		//var lPriceStr = cliGetLastPrice()
		//xLog("获取最新行情"+lPriceStr)	
		//lPriceNum = tonumber(lPriceStr)
		
		//if(nowTimeStr<"00:00:10"){ // 未到最后出价时间
		/*
		if(nowTimeStr<"112900"){ // 未到最后出价时间
			xLog("@	!!!! 112900 前 最终出价后，抢补出价")
			bidFinalAll("2")
			xLog("最终出价后，抢补出价完成!!!!	@")	
		}elseif(nowTimeStr<"112930") {
			xLog("@	!!!! 112900 后 最终出价后，抢补出价")
			priceBefore = bid1Time
			bidFinalAll("2")
			xLog("最终出价后，抢补出价完成!!!!	@")	
		}else {
			xLog("@	!!!! 112930 后 最终出价后，抢补出价")
			priceBefore = bid2Time
			bidFinalAll("2")
			xLog("最终出价后，抢补出价完成!!!!	@")	
		}
		*/
	}	
	//bidFinalAllPatch(")	
}




bidConfirmNice = function(){


		// 提交
	xLog("获取出价价格，并准备与最新行情进行比较，然后提交出价"+curBidPriceStr)	
	//var curBidPriceNum = 0
	try{
		curBidPriceNum = tonumber(curBidPriceStr)
		newform.edtBidPrice.text = curBidPriceStr;
		curBidPriceNumSub100 = curBidPriceNum - 100
		curBidPriceNumSub200 = curBidPriceNum - 200
		curBidPriceNumSub300 = curBidPriceNum - 300
	}
	catch(e)
	{
		..io.print(1899, "curBidPriceNum error !!!!")	
	}
	
	xLog("循环与最新行情进行比较，然后提交出价")
	var nowTimeStr = ""	
	while(true){	
	
		if (subThreadTable.isRunningbidNice == "n")
		{
			//subThreadTable.isRunningbidNice = "n"
			return ; 
		}
		win.delay(10);
	
		//win.delay(20)	
		//nowTime = time.now()
		//nowTime.format="%H%M%S";
		//nowTimeStr = tostring(nowTime) 
		nowTimeStrOld = ""
		
		var hqLastPriceStr = cliGetLastPrice()
		xLog("获取最新行情"+hqLastPriceStr)	
		hqLastPriceNum = tonumber(hqLastPriceStr)
		
		
		var bidSubHqPriceNum = curBidPriceNum - hqLastPriceNum; 
		
		
		// nowTimeStr 精确到  毫秒  
		nowTimeStr = getNowWithMs()
		
		if(nowTimeStr >= "112940000") and (nowTimeStr <= "112940999")
		{
			lastp40 = hqLastPriceNum;
		}
		//else if if(nowTimeStr >= "112940000") and (nowTimeStr <= "112940999")	{ lastp41 = hqLastPriceNum; }
		//else if (nowTimeStr == '112953')	{ lastp53 = lastpnum;  delta53_50 = lastp53 - lastp50; }
		//else if (nowTimeStr == '112954')	{ lastp54 = lastpnum;  delta54_50 = lastp54 - lastp50; }
		//else if (nowTimeStr == '112955')	{ lastp55 = lastpnum;  delta55_50 = lastp55 - lastp50; }
		else if(nowTimeStr >= "112900000") and	(nowTimeStr <= "112900999")	{ lastp00 = hqLastPriceNum; }
		//else if(nowTimeStr >= "112901000") and	(nowTimeStr <= "112901999")	{ lastp01 = hqLastPriceNum; }
		//else if(nowTimeStr >= "112902000") and	(nowTimeStr <= "112902999")	{ lastp02 = hqLastPriceNum; }
		//else if(nowTimeStr >= "112903000") and	(nowTimeStr <= "112903999")	{ lastp03 = hqLastPriceNum; }
		//else if(nowTimeStr >= "112904000") and	(nowTimeStr <= "112904999")	{ lastp04 = hqLastPriceNum; }
		else if(nowTimeStr >= "112905000") and	(nowTimeStr <= "112905999")	{ lastp05 = hqLastPriceNum; }
		//else if(nowTimeStr >= "112906000") and	(nowTimeStr <= "112906999")	{ lastp06 = hqLastPriceNum; }
		//else if(nowTimeStr >= "112907000") and	(nowTimeStr <= "112907999")	{ lastp07 = hqLastPriceNum; }
		//else if(nowTimeStr >= "112908000") and	(nowTimeStr <= "112908999")	{ lastp08 = hqLastPriceNum; }
		//else if(nowTimeStr >= "112909000") and	(nowTimeStr <= "112909999")	{ lastp09 = hqLastPriceNum; }
		else if(nowTimeStr >= "112910000") and	(nowTimeStr <= "112910999")	{ lastp10 = hqLastPriceNum; }
		//else if(nowTimeStr >= "112911000") and	(nowTimeStr <= "112911999")	{ lastp11 = hqLastPriceNum; }
		//else if(nowTimeStr >= "112912000") and	(nowTimeStr <= "112912999")	{ lastp12 = hqLastPriceNum; }
		//else if(nowTimeStr >= "112913000") and	(nowTimeStr <= "112913999")	{ lastp13 = hqLastPriceNum; }
		//else if(nowTimeStr >= "112914000") and	(nowTimeStr <= "112914999")	{ lastp14 = hqLastPriceNum; }
		else if(nowTimeStr >= "112915000") and	(nowTimeStr <= "112915999")	{ lastp15 = hqLastPriceNum; }
		//else if(nowTimeStr >= "112916000") and	(nowTimeStr <= "112916999")	{ lastp16 = hqLastPriceNum; }
		//else if(nowTimeStr >= "112917000") and	(nowTimeStr <= "112917999")	{ lastp17 = hqLastPriceNum; }
		//else if(nowTimeStr >= "112918000") and	(nowTimeStr <= "112918999")	{ lastp18 = hqLastPriceNum; }
		//else if(nowTimeStr >= "112919000") and	(nowTimeStr <= "112919999")	{ lastp19 = hqLastPriceNum; }
		else if(nowTimeStr >= "112920000") and	(nowTimeStr <= "112920999")	{ lastp20 = hqLastPriceNum; }
		//else if(nowTimeStr >= "112921000") and	(nowTimeStr <= "112921999")	{ lastp21 = hqLastPriceNum; }
		//else if(nowTimeStr >= "112922000") and	(nowTimeStr <= "112922999")	{ lastp22 = hqLastPriceNum; }
		//else if(nowTimeStr >= "112923000") and	(nowTimeStr <= "112923999")	{ lastp23 = hqLastPriceNum; }
		//else if(nowTimeStr >= "112924000") and	(nowTimeStr <= "112924999")	{ lastp24 = hqLastPriceNum; }
		else if(nowTimeStr >= "112925000") and	(nowTimeStr <= "112925999")	{ lastp25 = hqLastPriceNum; }
		//else if(nowTimeStr >= "112926000") and	(nowTimeStr <= "112926999")	{ lastp26 = hqLastPriceNum; }
		//else if(nowTimeStr >= "112927000") and	(nowTimeStr <= "112927999")	{ lastp27 = hqLastPriceNum; }
		//else if(nowTimeStr >= "112928000") and	(nowTimeStr <= "112928999")	{ lastp28 = hqLastPriceNum; }
		//else if(nowTimeStr >= "112929000") and	(nowTimeStr <= "112929999")	{ lastp29 = hqLastPriceNum; }
		else if(nowTimeStr >= "112930000") and	(nowTimeStr <= "112930999")	{ lastp30 = hqLastPriceNum; }
		//else if(nowTimeStr >= "112931000") and	(nowTimeStr <= "112931999")	{ lastp31 = hqLastPriceNum; }
		//else if(nowTimeStr >= "112932000") and	(nowTimeStr <= "112932999")	{ lastp32 = hqLastPriceNum; }
		//else if(nowTimeStr >= "112933000") and	(nowTimeStr <= "112933999")	{ lastp33 = hqLastPriceNum; }
		//else if(nowTimeStr >= "112934000") and	(nowTimeStr <= "112934999")	{ lastp34 = hqLastPriceNum; }
		else if(nowTimeStr >= "112935000") and	(nowTimeStr <= "112935999")	{ lastp35 = hqLastPriceNum; }
		//else if(nowTimeStr >= "112936000") and	(nowTimeStr <= "112936999")	{ lastp36 = hqLastPriceNum; }
		//else if(nowTimeStr >= "112937000") and	(nowTimeStr <= "112937999")	{ lastp37 = hqLastPriceNum; }
		//else if(nowTimeStr >= "112938000") and	(nowTimeStr <= "112938999")	{ lastp38 = hqLastPriceNum; }
		//else if(nowTimeStr >= "112939000") and	(nowTimeStr <= "112939999")	{ lastp39 = hqLastPriceNum; }
		else if(nowTimeStr >= "112940000") and	(nowTimeStr <= "112940999")	{ lastp40 = hqLastPriceNum; }
		//else if(nowTimeStr >= "112941000") and	(nowTimeStr <= "112941999")	{ lastp41 = hqLastPriceNum; }
		//else if(nowTimeStr >= "112942000") and	(nowTimeStr <= "112942999")	{ lastp42 = hqLastPriceNum; }
		//else if(nowTimeStr >= "112943000") and	(nowTimeStr <= "112943999")	{ lastp43 = hqLastPriceNum; }
		//else if(nowTimeStr >= "112944000") and	(nowTimeStr <= "112944999")	{ lastp44 = hqLastPriceNum; }
		else if(nowTimeStr >= "112945000") and	(nowTimeStr <= "112945999")	{ lastp45 = hqLastPriceNum; }
		else if(nowTimeStr >= "112946000") and	(nowTimeStr <= "112946999")	{ lastp46 = hqLastPriceNum; }
		else if(nowTimeStr >= "112947000") and	(nowTimeStr <= "112947999")	{ lastp47 = hqLastPriceNum; }
		else if(nowTimeStr >= "112948000") and	(nowTimeStr <= "112948999")	{ lastp48 = hqLastPriceNum; }
		else if(nowTimeStr >= "112949000") and	(nowTimeStr <= "112949999")	{ lastp49 = hqLastPriceNum; }
		else if(nowTimeStr >= "112950000") and	(nowTimeStr <= "112950999")	{ lastp50 = hqLastPriceNum; }
		else if(nowTimeStr >= "112951000") and	(nowTimeStr <= "112951999")	{ lastp51 = hqLastPriceNum; }
		else if(nowTimeStr >= "112952000") and	(nowTimeStr <= "112952999")	{ lastp52 = hqLastPriceNum; }
		else if(nowTimeStr >= "112953000") and	(nowTimeStr <= "112953999")	{ lastp53 = hqLastPriceNum; }
		else if(nowTimeStr >= "112954000") and	(nowTimeStr <= "112954999")	{ lastp54 = hqLastPriceNum; }
		else if(nowTimeStr >= "112955000") and	(nowTimeStr <= "112955999")	{ lastp55 = hqLastPriceNum; }
		else if(nowTimeStr >= "112956000") and	(nowTimeStr <= "112956999")	{ lastp56 = hqLastPriceNum; }
		else if(nowTimeStr >= "112957000") and	(nowTimeStr <= "112957999")	{ lastp57 = hqLastPriceNum; }
		else if(nowTimeStr >= "112958000") and	(nowTimeStr <= "112958999")	{ lastp58 = hqLastPriceNum; }
		else if(nowTimeStr >= "112959000") and	(nowTimeStr <= "112959999")	{ lastp59 = hqLastPriceNum; }
				
		
		if(nowTimeStr >= "112955500") 
		{
			 delta55_50 = lastp55 - lastp50;
		}
		else if(nowTimeStr >= "112954500") {  delta54_50 = lastp54 - lastp50; }
		else if(nowTimeStr >= "112953500") {  delta53_50 = lastp53 - lastp50; }
		else if(nowTimeStr >= "112952500") {  delta52_50 = lastp52 - lastp50; }

		if(nowTimeStr<timeLine){ // 未到最后出价时间    112955-000  平均提交耗时 4.2s
			xLog("未到最后出价时间，行情："+hqLastPriceStr+";   出价："+curBidPriceStr)
			win.delay(10)
			
			//..io.print(1730, "curPriceBid:", curBidPriceNum, "hqLastPrice:", hqLastPriceNum)
			
			if (hqLastPriceNum >= curBidPriceNum) { // 如果，目前最高价，大于出价，立即发出
				
				pressF3()			
				xLog("###	!!!立即出价!!!  当前时间"+nowTimeStr+"  行情 到达(大于等于) 出价，行情："+hqLastPriceStr+";     出价："+curBidPriceStr)	
				newform.edtBidTime.text = nowTimeStr;
				break;
			}	
	
			//elseif (hqLastPriceNum >= curBidPriceNumSub100){ // 如果最高价 距离 出价 还有 1个档位，立即出价
				//if 	(nowTimeStr>="112950")	{ // 50秒后，价格还差100，就可以选择出价了
				//	xLog("行情到达出价-100，立即出价，行情："+lPriceStr+"，出价："+curBidPriceStr)	
				//	pressF3()
				//	break;	
				//}
			//}
			
			if(nowTimeStr >= bid2Time){   //  112953 000   
				if (hqLastPriceNum >= curBidPriceNumSub100) {
					
					pressF3()  // clk cancel btn
					xLog("###	!!!提前100出价!!!   当前时间"+nowTimeStr+"大于等于"+bid2Time+ "且行情比出价高100, 行情:"+hqLastPriceStr+";     出价："+curBidPriceStr)
					newform.edtBidTime.text = nowTimeStr;
					break;	
				}
			}
			
			if(nowTimeStr >= bid4Time){ // 112954-000
				if (hqLastPriceNum >= curBidPriceNumSub200) {
					
					pressF3()  // clk cancel btn
					xLog("###	!!!提前200出价!!!   当前时间"+nowTimeStr+"大于等于"+bid4Time+ "且行情比出价高200, 行情:"+hqLastPriceStr+";     出价："+curBidPriceStr)
					newform.edtBidTime.text = nowTimeStr;
					break;	
				}
			}
			
	
			
			if(nowTimeStr >= "112940000"){ // nowTimeStr 精确到  毫秒  112940-000 
				if (bidSubHqPriceNum >= 1500) {
					xLog("###	!!!出价过高重新出价!!!   当前时间"+nowTimeStr+"大于等于 112940 ， 且行情比出价高1500, 立即点击取消按钮，进入bidNice2下次出价!!! 行情:"+hqLastPriceStr+";     出价："+curBidPriceStr)
					clkBidCancel300()  // clk cancel btn
					break;	
				}
			}
			
		}
		else {  // 到了最后出价时间，不管任何情况，选择出价 // 53秒后，不管任何情况都应该出价了
			
			pressF3()
			xLog("###	!!!强制出价!!!      当前时间"+nowTimeStr+"到达最后出价时间:"+timeLine+" 强制出价,，行情："+hqLastPriceNum+"，出价："+curBidPriceStr)
			newform.edtBidTime.text = nowTimeStr;
			break;	
		}
	}
	newform.edtBidTime.text = nowTimeStr+'-'+curBidPriceStr;
	xLog("###	!!!最终出价!!!      当前时间："+nowTimeStr+"行情："+hqLastPriceNum+"，出价："+curBidPriceStr);		
}


getAddPriceNice = function(){
	var nowTimeStr = getNowTimeNiceSS()
	
	nowTime1 = time.now()
	nowTime1.format="%H%M%S";
	nowTimeStr1 = tostring(nowTime) 
	
	if(nowTimeStr1<"112900"){
		return "1800"	
	}
	else{
		xLog("####  getAddPriceNice  ####"+nowTimeStr+"秒")
		if (nowTimeStr <= "10")
			return "1600"
		elseif(nowTimeStr <= "13"){
			return "1600"
		}
		elseif(nowTimeStr <= "15"){
			return "1600"
		}
		elseif(nowTimeStr <= "18"){
			return "1500"
		}
		elseif(nowTimeStr <= "20"){
			return "1500"
		}
		elseif(nowTimeStr <= "22"){
			return "1400"
		}
		elseif(nowTimeStr <= "24"){
			return "1300"
		}
		elseif(nowTimeStr <= "28"){
			return "1200"
		}
		elseif(nowTimeStr <= "30"){
			return "1100"
		}
		elseif(nowTimeStr <= "32"){
			return "1100"
		}
		elseif(nowTimeStr <= "35"){
			return "1100"
		}
		elseif(nowTimeStr <= "37"){
			return "1100"
		}
		elseif(nowTimeStr <= "39"){
			return "1100"
		}
		elseif(nowTimeStr == "40"){
			return "1100"
		}	
		elseif(nowTimeStr == "41"){
			return "1100"
		}
		elseif(nowTimeStr == "42"){
			return "1100"
		}
		elseif(nowTimeStr == "43"){
			return "1000"
		}	
		elseif(nowTimeStr == "44"){
			return "1000"
		}
		elseif(nowTimeStr == "45"){
			return "1000"
		}
		elseif(nowTimeStr == "46"){
			return "900"
		}	
		elseif(nowTimeStr == "47"){
			return "900"
		}	
		elseif(nowTimeStr == "48"){
			return "800"
		}
		elseif(nowTimeStr == "49"){
			return "800"
		}
		elseif(nowTimeStr == "50"){
			return "600"
		}
		elseif(nowTimeStr == "51"){
			return "600"
		}
		else {
			return "300"
		}
	}
		
}

getBidPriceNice = function(varBidPrice){
	
	//客户端
	import zeromq
	
	//io.open()
	var context = zeromq.context(1) 
	//request模式socket与服务端的reply模式配对使用
	var requester = context.zmq_socket_request() ;
	
	//requester.connect( "tcp://localhost:5559" )
	
	import thread.table
	var tab = thread.table("subPrice")
			
	if( requester.connect( "tcp://"+tab.ip+":51111" ) )
	{
    	..io.print("连接成功")
	}
	var sendBidPriceMsg = "getPrice-"+varBidPrice  // 
	var msg = zeromq.message(sendBidPriceMsg)  
	requester.sendMsg(msg)
	msg.close();
	
	var reply = zeromq.message()  
	requester.recvMsg(reply);  
	resultBidPrice = reply.getString();
	reply.close()
	
	context.term(); 
	
	return  resultBidPrice; 
}


bidNice2 = function(){

	xLog("!!!!	开始最终出价")
	startTime1 = time.now()
	startTime1.format="%H%M%S";
	xLog("F1 Start...从配置中输入自定义加价，点击自定义加价，点击出价获取验证码", startTime1)
	
	// 提交出价
	
	
	
	
	var tmpAddPrice = getAddPriceNice()
	xLog("##3166##  getAddPriceNice  #### ===  "+tmpAddPrice)
	pressF1Nice(tmpAddPrice) // 从配置中输入自定义加价，点击自定义加价，点击出价获取验证码
	
	xLog("	##	提交出价")
		
	// 等待验证码， 如果 识别码 不对，应超时跳出，或重取验证码
	xLog("循环等待获取识别码，2秒超时")
	var sbmTimeOut = 0
	//while(true){
		/*
		var vtype = getImgSbm()
		
		xLog("3183-bidNice-vtype:"+vtype)
		
		if  (vtype != "") and (string.indexOf(qCode, vtype)!=null) {
			break;
		}
		else if (vtype != "") and (string.indexOf(zCode, vtype)!=null){
			break;
		}
		else if (vtype != "") and (string.indexOf(hCode, vtype)!=null){
			break;
		}
		*/
	
		sbmTimeOut = sbmTimeOut + 100
		win.delay(100)
		
		//if (sbmTimeOut > 550){  // 2秒后超时
		//	import mouse
		//	mouse.click( xImgTopBtn+20, yImgTopBtn+20,true); 
		//	win.delay(50)
		//	mouse.click(xImgBtomBtn-20, yImgBtomBtn-20, true);
		
		//	xLog("###	！！！验证码识别码超时，["+getNowTime()+"] sbmTimeOut："+tostring(sbmTimeOut))
		//	break;
		//}
	//}				
		
	xLog("开始发起验证码识别")	
	// 识别验证码并输入
	xLog("###	开始识别验证码，["+getNowTime()+"] 验证码识别类型-yzmType："+yzmType)
	var tmpCodeResult = pressF7(yzmType)
	xLog("###	完成识别验证码，["+getNowTime()+"] 验证码识别结果-gCode："+tmpCodeResult)
	xLog("##	输入验证码完成")
	//mainForm.msgbox(nowTimeStr+"-"+gDoneTimer)
		
	// 提交
	xLog("获取出价价格，并准备与最新行情进行比较，然后提交出价"+curBidPriceStr)	
	if (tmpCodeResult == "1111")
	{	
		clkBidCancel300()
		clkErrWndBtn300()
		win.delay(500)
		bidNice2()		
	}
	elseif(tmpCodeResult == "y"){
		import mouse
		mouse.click( xImgTopBtn+20, yImgTopBtn+20,true); 
		
		//clkBidCancel300()
		//clkErrWndBtn300()
		win.delay(100)
		tmpCodeResult = pressF7(yzmType)
		//bidNice2()	
		
		if(tmpCodeResult == "y"){
			clkBidCancel300()
			clkErrWndBtn300()
			win.delay(500)
			bidNice2()	
		}	
		else
			bidConfirmNice()
	}	
	else
		bidConfirmNice()
		
	subThreadTable.threadRecImgResult = "";
		
	
	
	startTime2 = time.now()
	startTime2.format="%H%M%S";	
	..io.print("bid final all cost :", startTime2, tonumber(startTime2)-tonumber(startTime1))
	
	xLog("!!!!	结束最终出价,	全过程耗时：	"+(tonumber(startTime2)-tonumber(startTime1)))
	xLogFlush()

	
}


bidNice_1111 = function(){
	
}

bidNice_Y = function(){
	
}


subThreadTable.isRunningbidNice = "n"

bidNice = function(){

	if (subThreadTable.isRunningbidNice == "n")
	{
		subThreadTable.isRunningbidNice = "y"
	}else {  // if "y"		
		//subThreadTable.isRunningbidNice = "s"
		//while(subThreadTable.isRunningbidNice != "n") 	
		//{
		//	sleep(100)	
		//}
		
		//clkBidCancel300()  // 点击取消出价，然后开始重新出价	
		//sleep(200)
		//clkBidCancel300()	
		//subThreadTable.isRunningbidNice = "y"			
	}
	

	xLog("!!!!	开始最终出价")
	startTime1 = time.now()
	startTime1.format="%H%M%S";
	xLog("F1 Start...从配置中输入自定义加价，点击自定义加价，点击出价获取验证码", startTime1)
	
	// 提交出价
	//检查验证码识别结果 不为 1111， y 时， 为首次提交出价, 否则直接点击出价
	pressF1() // 从配置中输入自定义加价，点击自定义加价，点击出价获取验证码, 
	
	xLog("	##	提交出价")
		
	// 等待验证码， 如果 识别码 不对，应超时跳出，或重取验证码
	xLog("循环等待获取识别码，2秒超时")
	var sbmTimeOut = 0
	//while(true){
		/*
		var vtype = getImgSbm()
		
		xLog("3183-bidNice-vtype:"+vtype)
		
		if  (vtype != "") and (string.indexOf(qCode, vtype)!=null) {
			break;
		}
		else if (vtype != "") and (string.indexOf(zCode, vtype)!=null){
			break;
		}
		else if (vtype != "") and (string.indexOf(hCode, vtype)!=null){
			break;
		}
		*/
		win.delay(600)
		
		import mouse
		mouse.click( xImgTopBtn+20, yImgTopBtn+20,true); 
		win.delay(50)
		mouse.click(xImgBtomBtn-20, yImgBtomBtn-20, true);
		
		sbmTimeOut = sbmTimeOut + 300
		
		
	//	if (sbmTimeOut > 400){  // 2秒后超时
	//		xLog("###	！！！验证码识别码超时，["+getNowTime()+"] sbmTimeOut："+tostring(sbmTimeOut))
	//		break;
	//	}
	//}				
		
	xLog("开始发起验证码识别")	
	// 识别验证码并输入
	xLog("###	开始识别验证码，["+getNowTime()+"] 验证码识别类型-yzmType："+yzmType)
	var tmpCodeResult = pressF7("allndmt")
	xLog("###	完成识别验证码，["+getNowTime()+"] 验证码识别结果-gCode："+tmpCodeResult)
	xLog("##	输入验证码完成")
	//mainForm.msgbox(nowTimeStr+"-"+gDoneTimer)
		
	// 提交
	xLog("获取出价价格，并准备与最新行情进行比较，然后提交出价"+curBidPriceStr)	
	if (tmpCodeResult == "1111")
	{	
		clkBidCancel300()
		clkErrWndBtn300()		
		win.delay(500)
		bidNice()		
	}
	elseif(tmpCodeResult == "y"){
		xLog("点击刷新验证码，F7重新发起验证码识别"+curBidPriceStr)	
		mouse.click( xImgTopBtn+20, yImgTopBtn+20,true); 
		win.delay(50)
		mouse.click(xImgBtomBtn-20, yImgBtomBtn-20, true);
		win.delay(100)
		
		tmpCodeResult = pressF7("allndmt")
		
		if(tmpCodeResult == "y"){
			clkBidCancel300()
			clkErrWndBtn300()
			win.delay(500)
			bidNice()	
		}	
		else
			bidConfirmNice()
	}
	else
		bidConfirmNice()
		

		
	subThreadTable.threadRecImgResult = "";

	
	if (subThreadTable.isRunningbidNice == "n"){
		//subThreadTable.isRunningbidNice = "n"
		clkBidCancel300()
		xLog("取消出价执行，重新进行最后出价, subThreadTable.isRunningbidNice", subThreadTable.isRunningbidNice)
		return ; 
	}
		
	
	
	startTime2 = time.now()
	startTime2.format="%H%M%S";	
	..io.print("bid final all cost :", startTime2, tonumber(startTime2)-tonumber(startTime1))
	
	xLog("!!!!	结束最终出价,	全过程耗时：	"+(tonumber(startTime2)-tonumber(startTime1)))
	xLogFlush()
	
	isBidPageNice() // 等待，直到返回到主页
	
	bidNice2()
	
	//thread.create(threadSendMsgToMgrSvr)
	
	clkErrWndBtn300()	
	
	//isBidPageNice() // 等待，直到返回到主页
	
	//bidNice2()
	subThreadTable.isRunningbidNice = "n"
	
	//clkErrWndBtn300()	
}

// 29 分直接出价，自动，提交验证码识别
bidNiceAt29Auto = function(varBidPrice){

	if (subThreadTable.isRunningbidNice == "n")
	{
		subThreadTable.isRunningbidNice = "y"
	}else {  // if "y"		
		//subThreadTable.isRunningbidNice = "s"
		//while(subThreadTable.isRunningbidNice != "n") 	
		//{
		//	sleep(100)	
		//}
		
		//clkBidCancel300()  // 点击取消出价，然后开始重新出价	
		//sleep(200)
		//clkBidCancel300()	
		//subThreadTable.isRunningbidNice = "y"			
	}
	

	xLog("!!!!	开始最终出价")
	startTime1 = time.now()
	startTime1.format="%H%M%S";
	xLog("F1 Start...从配置中输入自定义加价，点击自定义加价，点击出价获取验证码", startTime1)
	
	// 提交出价
	//检查验证码识别结果 不为 1111， y 时， 为首次提交出价, 否则直接点击出价
	pressF1Tmp(varBidPrice) // 从配置中输入自定义加价，点击自定义加价，点击出价获取验证码, 
	
	xLog("	##	提交出价")
		
	// 等待验证码， 如果 识别码 不对，应超时跳出，或重取验证码
	xLog("循环等待获取识别码，2秒超时")
	var sbmTimeOut = 0
	//while(true){
		/*
		var vtype = getImgSbm()
		
		xLog("3183-bidNice-vtype:"+vtype)
		
		if  (vtype != "") and (string.indexOf(qCode, vtype)!=null) {
			break;
		}
		else if (vtype != "") and (string.indexOf(zCode, vtype)!=null){
			break;
		}
		else if (vtype != "") and (string.indexOf(hCode, vtype)!=null){
			break;
		}
		*/
		win.delay(100)
		
		//import mouse
		//mouse.click( xImgTopBtn+20, yImgTopBtn+20,true); 
		//win.delay(50)
		//mouse.click(xImgBtomBtn-20, yImgBtomBtn-20, true);
		
		sbmTimeOut = sbmTimeOut + 300
		
		
	//	if (sbmTimeOut > 400){  // 2秒后超时
	//		xLog("###	！！！验证码识别码超时，["+getNowTime()+"] sbmTimeOut："+tostring(sbmTimeOut))
	//		break;
	//	}
	//}				
		
	xLog("开始发起验证码识别")	
	// 识别验证码并输入
	xLog("###	开始识别验证码，["+getNowTime()+"] 验证码识别类型-yzmType："+yzmType)
	var tmpCodeResult = pressF7("allndmt")
	xLog("###	完成识别验证码，["+getNowTime()+"] 验证码识别结果-gCode："+tmpCodeResult)
	xLog("##	输入验证码完成")
	//mainForm.msgbox(nowTimeStr+"-"+gDoneTimer)
		
	// 提交
	xLog("获取出价价格，并准备与最新行情进行比较，然后提交出价"+curBidPriceStr)	
	if (tmpCodeResult == "1111")
	{	
		clkBidCancel300()
		clkErrWndBtn300()		
		win.delay(500)
		bidNice()		
	}
	elseif(tmpCodeResult == "y"){
		xLog("点击刷新验证码，F7重新发起验证码识别"+curBidPriceStr)	
		mouse.click( xImgTopBtn+20, yImgTopBtn+20,true); 
		win.delay(50)
		mouse.click(xImgBtomBtn-20, yImgBtomBtn-20, true);
		win.delay(50)
		
		tmpCodeResult = pressF7("allndmt")
		
		if(tmpCodeResult == "y"){
			clkBidCancel300()
			clkErrWndBtn300()
			win.delay(500)
			bidNice()	
		}	
		else
			bidConfirmNice()
	}
	else
		bidConfirmNice()
		

		
	subThreadTable.threadRecImgResult = "";

	
	if (subThreadTable.isRunningbidNice == "n"){
		//subThreadTable.isRunningbidNice = "n"
		clkBidCancel300()
		xLog("取消出价执行，重新进行最后出价, subThreadTable.isRunningbidNice", subThreadTable.isRunningbidNice)
		return ; 
	}
		
	
	
	startTime2 = time.now()
	startTime2.format="%H%M%S";	
	..io.print("bid final all cost :", startTime2, tonumber(startTime2)-tonumber(startTime1))
	
	xLog("!!!!	结束最终出价,	全过程耗时：	"+(tonumber(startTime2)-tonumber(startTime1)))
	xLogFlush()
	
	isBidPageNice() // 等待，直到返回到主页
	
	bidNice2()
	
	//thread.create(threadSendMsgToMgrSvr)
	
	clkErrWndBtn300()	
	
	//isBidPageNice() // 等待，直到返回到主页
	
	//bidNice2()
	subThreadTable.isRunningbidNice = "n"
	
	//clkErrWndBtn300()	
}


//  直接出价 入口
bidNiceTmp = function(varBidPrice){

	if (subThreadTable.isRunningbidNice == "n")
	{
		subThreadTable.isRunningbidNice = "y"
	}else {  // if "y"		
		//subThreadTable.isRunningbidNice = "s"
		//while(subThreadTable.isRunningbidNice != "n") 	
		//{
		//	sleep(100)	
		//}
		
		//clkBidCancel300()  // 点击取消出价，然后开始重新出价	
		//sleep(200)
		//clkBidCancel300()	
		//subThreadTable.isRunningbidNice = "y"			
	}


	xLog("!!!!	开始最终出价")
	startTime1 = time.now()
	startTime1.format="%H%M%S";
	xLog("F1 Start...从配置中输入自定义加价，点击自定义加价，点击出价获取验证码", startTime1)
	
	// 提交出价
	//检查验证码识别结果 不为 1111， y 时， 为首次提交出价, 否则直接点击出价
	pressF1Tmp(varBidPrice) // 从配置中输入自定义加价，点击自定义加价，点击出价获取验证码, 
	
	xLog("	##	提交出价")
		
	// 等待验证码， 如果 识别码 不对，应超时跳出，或重取验证码
	//xLog("循环等待获取识别码，2秒超时")
	//var sbmTimeOut = 0

	//win.delay(600)
		
	//import mouse
	//mouse.click( xImgTopBtn+20, yImgTopBtn+20,true); 
	//win.delay(50)
	//mouse.click(xImgBtomBtn-20, yImgBtomBtn-20, true);
		
	//sbmTimeOut = sbmTimeOut + 300
	
	// 选定验证码输入框
	mouse.click(xImgEdt, yImgEdt, true);				
		
	xLog("开始发起验证码识别")	
	// 识别验证码并输入
	//xLog("###	开始识别验证码，["+getNowTime()+"] 验证码识别类型-yzmType："+yzmType)
	//var tmpCodeResult = pressF7("allndmt")
	//xLog("###	完成识别验证码，["+getNowTime()+"] 验证码识别结果-gCode："+tmpCodeResult)
	//xLog("##	输入验证码完成")
	//mainForm.msgbox(nowTimeStr+"-"+gDoneTimer)
		
	// 提交
	bidConfirmNice()
	/*
	xLog("获取出价价格，并准备与最新行情进行比较，然后提交出价"+curBidPriceStr)	
	if (tmpCodeResult == "1111")
	{	
		clkBidCancel300()
		clkErrWndBtn300()		
		win.delay(500)
		bidNice()		
	}
	elseif(tmpCodeResult == "y"){
		xLog("点击刷新验证码，F7重新发起验证码识别"+curBidPriceStr)	
		mouse.click( xImgTopBtn+20, yImgTopBtn+20,true); 
		win.delay(50)
		mouse.click(xImgBtomBtn-20, yImgBtomBtn-20, true);
		win.delay(100)
		
		tmpCodeResult = pressF7("allndmt")
		
		if(tmpCodeResult == "y"){
			clkBidCancel300()
			clkErrWndBtn300()
			win.delay(500)
			bidNice()	
		}	
		else
			bidConfirmNice()
	}
	else
		bidConfirmNice()
	*/	

		
	subThreadTable.threadRecImgResult = "";

	
	if (subThreadTable.isRunningbidNice == "n"){
		//subThreadTable.isRunningbidNice = "n"
		clkBidCancel300()
		xLog("取消出价执行，重新进行最后出价, subThreadTable.isRunningbidNice", subThreadTable.isRunningbidNice)
		return ; 
	}
		
	
	
	startTime2 = time.now()
	startTime2.format="%H%M%S";	
	..io.print("bid final all cost :", startTime2, tonumber(startTime2)-tonumber(startTime1))
	
	xLog("!!!!	结束最终出价,	全过程耗时：	"+(tonumber(startTime2)-tonumber(startTime1)))
	xLogFlush()
	
	isBidPageNice() // 等待，直到返回到主页
	
	bidNice2()
	
	//thread.create(threadSendMsgToMgrSvr)
	
	clkErrWndBtn300()	
	
	//isBidPageNice() // 等待，直到返回到主页
	
	//bidNice2()
	subThreadTable.isRunningbidNice = "n"
	
	//clkErrWndBtn300()	
}


bidTestAll = function(){
	pressF1()
	win.delay(2000)
	pressF7("allndmt")
	win.delay(2000)
	clkBidCancel300() 	
}

ccmdallclkTipWindowConfirm = function(){//点击确认框
	pressF3()		
}

ccmdallclkTipWindowConfirmTest = function(){// 点击测试确认按钮
	clkErrWndBtn300()				
}


ccmdallclkOpenWebTest = function(){// 点击打开测试页面链接
	clkBtnValue(383,82)		
	win.delay(5000)
	clkBtnValue(922,564)	
	win.delay(1000)	
	clkBtnValue(922,564)		
}


ccmdallclkIETip = function(){// 点击重启浏览器提示按钮
	clkBtnValue(763,464)
}


ccmdallsnapscreen = function(){// 截取全屏bmp
	snapImg.snapFullScreen()
}


// 设置自定义加价
setCustomAddPriceEdtValue = function(){
	import mouse
	mouse.clickDb(xCustomAddPriceEdt,yCustomAddPriceEdt,true)	
	win.delay(10)
	key.press(0x8/*_VK_BACK*/)
	win.delay(10)
    import key
    //key.send(string.sub()
    //key.send(f1Price,2)

    import win.clip
    key.combine("CTRL","a")
    win.delay(20) 
	win.clip.write(f1Price)
    win.delay(20)
    key.combine("CTRL","v")
    
    win.delay(10)	
}


// 设置自定义加价
setCustomAddPriceEdtValueNice = function(addPrice){
	import mouse
	mouse.clickDb(xCustomAddPriceEdt,yCustomAddPriceEdt,true)	
	win.delay(10)
	key.press(0x8/*_VK_BACK*/)
	win.delay(10)
    import key
    //key.send(string.sub()
    //key.send(f1Price,2)

    import win.clip
    key.combine("CTRL","a")
    win.delay(20) 
	win.clip.write(addPrice)
    win.delay(20)
    key.combine("CTRL","v")
    
    win.delay(10)	
}


// 设置直接出价价格
setCustomBidPriceEdtValueNice = function(bidPrice){
	import mouse
	mouse.clickDb(xPriceEdt,yPriceEdt,true)	
	win.delay(10)
	key.press(0x8/*_VK_BACK*/)
	win.delay(10)
    import key
    //key.send(string.sub()
    //key.send(f1Price,2)

    import win.clip
    key.combine("CTRL","a")
    win.delay(20) 
	win.clip.write(bidPrice)
    win.delay(20)
    key.combine("CTRL","v")
    
    win.delay(10)	
}


// 点击自定义加价
clkCustomAddPriceBtn = function(){
	import mouse
	mouse.click( xCustomAddPriceBtn, yCustomAddPriceBtn,true); 	
	mouse.move(0,0,true)
}





///###hotkey

import key.hotkey; 

//
hotkey = key.hotkey(mainForm) 

hotkey.reg(
    "ALT","P", 
    function(hwnd,...){
        ..io.print("ALT=P", "loginOnce")
        loginOnce()
    } 
)



hotkey.reg(
    "ALT","I", 
    function(hwnd,...){
        ..io.print("1306-ALT=i","gStopFlag", gStopFlag)
       	if (gStopFlag == "0"){
       		gStopFlag = "1"
       	}else {
       		gStopFlag = "0"
       	}
       	
    } 
)

hotkey.reg(
    "ALT","1", 
    function(hwnd,...){
        //..io.print("1306-ALT=i","gStopFlag", gStopFlag)
		//import        	
		import win.clip
		win.clip.write(user)
		import key
    	key.combine("CTRL","a")
    	win.delay(20)
    	key.combine("CTRL","v")
    	win.delay(20)	
    } 
)


hotkey.reg(
    "ALT","2", 
    function(hwnd,...){
        //..io.print("1306-ALT=i","gStopFlag", gStopFlag)
		//import        	
		import win.clip
		win.clip.write(pwd)
		import key
    	key.combine("CTRL","a")
    	win.delay(20)
    	key.combine("CTRL","v")
    	win.delay(20)	
    } 
)


hotkey.reg(
    "ALT","3", 
    function(hwnd,...){
        //..io.print("1306-ALT=i","gStopFlag", gStopFlag)
		//import        	
		import win.clip
		win.clip.write(idNo)
		import key
    	key.combine("CTRL","a")
    	//win.delay(20)
    	key.combine("CTRL","v")
    	//win.delay(20)	
    } 
)



hotkey.reg(
    "CTRL","1", 
    function(hwnd,...){
		openLoginPageAll()
    } 
)


hotkey.reg(
    "CTRL","2", 
    function(hwnd,...){
		loginOnceAll()	
    } 
)


hotkey.reg(
    "CTRL","3", 
    function(hwnd,...){
		bidOnceAll()
    } 
)


hotkey.reg(
    "CTRL","4", 
    function(hwnd,...){
		bidTwiceAll()
    } 
)

hotkey.reg(
    "CTRL","5", 
    function(hwnd,...){
		//bidFinalAll()
		bidNice()
    } 
)


hotkey.reg(
    "CTRL","6", 
    function(hwnd,...){
		bidNiceAt29Auto(tostring(bidPriceAt29+tonumber(priceBefore)))
    } 
)



hotkey.reg(
    "CTRL","7", 
    function(hwnd,...){
		bidOnceAllGs()
    } 
)




hotkey.reg(
    "SHIFT","F1", 
    function(hwnd,...){
		bidNiceTmp("87300")
    } 
)


hotkey.reg(
    "SHIFT","F2", 
    function(hwnd,...){
		bidNiceTmp("87400")
    } 
)



hotkey.reg(
    "SHIFT","F3", 
    function(hwnd,...){
		bidNiceTmp("87500")
    } 
)



hotkey.reg(
    "SHIFT","F4", 
    function(hwnd,...){
		bidNiceTmp("87600")
    } 
)





hotkey.reg(
    "SHIFT","F5", 
    function(hwnd,...){
		bidNiceTmp("87700")
    } 
)




hotkey.reg(
    "SHIFT","F6", 
    function(hwnd,...){
		bidNiceTmp("87800")
    } 
)




hotkey.reg(
    "SHIFT","F7", 
    function(hwnd,...){
		bidNiceTmp("87900")
    } 
)




hotkey.reg(
    "SHIFT","F8", 
    function(hwnd,...){
		bidNiceTmp("88800")
    } 
)


hotkey.reg(
    "SHIFT","F9", 
    function(hwnd,...){
		bidNiceTmp("88900")
    } 
)




// alt + k  开始暂停录像
startCamPauseRecordNew = function(){
	xLog("开始暂停录像")
	key.combine("CTRL","ALT", "SHIFT", "F2")
}


startCamPauseRecord = function(){
	//xLog("开始暂停录像")
	//key.combine("ALT","K")
}

// alt + j 停止录像
stopCamRecord =  function(){
	//xLog("停止录像")
	//key.combine("ALT","L")
}


hk.proc=function(msg,vkcode,scancode){
    var kn = key.getName( vkcode ); 
    
    if autoKeyEnable { 
    	select(msg) {
        case 0x100/*_WM_KEYDOWN*/ ,0x104/*_WM_SYSKEYDOWN*/{
	
            if  (kn == "F1") or (kn == "\"){ // +300    873￡? 443
				pressF1()
            }
            else if  (kn == "F4")or (kn = "`"){ //3???   1032￡? 493
				clkBidCancel300()  // clk cancel btn
				win.delay(200)
				clkErrWndBtn300()	
            }
            else if  (kn == "F3") {//or (kn = "ENTER"){ // è・è?ìá??    781￡? 569
				pressF3()
            }
          //  else if  (kn == "F4"){ // 1?±?ìáê?     888￡? 550
          //  	clkErrWndBtn300()
          //  }
            else if  (kn == "F5"){ //出价减100
          //  	setPrice(100)
          		subThreadTable.isRunningbidNice = "n"	 // 设置通知信号，终止  bidnice 执行
          	    var tmpNum = tonumber(f1Price)
          	   	f1Price = tostring(tmpNum-100) 
          	   //	clkBidCancel300()  // 
            }
            else if  (kn == "F6"){ // 出价加100   // 设置通知信号，终止  bidnice 执行
				//thread.create(threadRecImgJpp)	
				//startThreadRecImg("allndmt")
				subThreadTable.isRunningbidNice = "n"
				var tmpNum = tonumber(f1Price)
          	   	f1Price = tostring(tmpNum+100) 
            }
			else if  (kn == "F7"){ 
				xLog("start F7")
				pressF7(yzmType)
				xLog("end F7")
				xLogFlush()
            }  
            else if  (kn == "F8"){
            	mainForm.picturebox5.image = "\qmt.jpg"
				mainForm.edit5.text = getImgSbm()
				
				mainForm.picturebox5.redraw()
				mainForm.picturebox5.image = "\imgSbm.jpg"
				mainForm.picturebox5.redraw()
				
				
				
				
				// 识别最高价
				//mainForm.picturebox6.image = "\qmt.jpg"
				//mainForm.edit8.text = getImgPriceHigh()
				
				//mainForm.picturebox6.redraw()
				//mainForm.picturebox6.image = "\imgPrice.jpg"
				//mainForm.picturebox6.redraw()
				
				
            }
            else if  (kn == "F9"){ // 1???§?è???ì???ì?¨|??ìo?     888??§o? 550
            	mainForm.picturebox5.image = "\qmt.jpg"
				mainForm.edit5.text = getImgSbmNice()
				
				mainForm.picturebox5.redraw()
				mainForm.picturebox5.image = "\imgSbmBP.jpg"
				mainForm.picturebox5.redraw()
				//win.setForeground(win.find("","【聚・拍牌】官方发布-一键拍牌-2015年8月12日"))
            }          
            
            else if  (kn == "F10"){ // ????×?±ê
            
            	import mouse
            	x, y  = mouse.getPos()
            	mainForm.edit3.text = tostring(x) + ", " + tostring(y)
				if mainForm.radiobutton.checked {
					secSys.xPrice300 = x
					secSys.yPrice300 = y
				}
				else if mainForm.radiobutton2.checked {
					secSys.xPriceEdt = x
					secSys.yPriceEdt = y
				}	
				else if mainForm.radiobutton3.checked {
					secSys.xPriceBtn = x
					secSys.yPriceBtn = y
				}	
				else if mainForm.radiobutton4.checked {	
					secSys.xConfirmBtn = x
					secSys.yConfirmBtn = y
				}	
				else if mainForm.radiobutton5.checked {	
					secSys.xCancelBtn = x
					secSys.yCancelBtn = y
				}	
				else if mainForm.radiobutton6.checked {
					secSys.xErrorBtn = x
					secSys.yErrorBtn = y
				}	
				else if mainForm.radiobutton7.checked {	
					secSys.xImgTopBtn = x
					secSys.yImgTopBtn = y
				}	
				else if mainForm.radiobutton8.checked {
					secSys.xImgBtomBtn = x
					secSys.yImgBtomBtn = y
				}				
				else if mainForm.radiobutton9.checked {
					secSys.xImgTopBtnFlag = x
					secSys.yImgTopBtnFlag = y
				}				
				else if mainForm.radiobutton10.checked {
					secSys.xImgBtomBtnFlag = x
					secSys.yImgBtomBtnFlag = y
				}	
				else if mainForm.radiobutton11.checked {
					secSys.xImgEdt = x
					secSys.yImgEdt = y
				}				
				else if mainForm.radiobutton12.checked {
					secSys.xImgTopBtnFlagPrice = x
					secSys.yImgTopBtnFlagPrice = y
				}				
				else if mainForm.radiobutton13.checked {
					secSys.xImgBtomBtnFlagPrice = x
					secSys.yImgBtomBtnFlagPrice = y
				}////---------
				else if mainForm.radiobutton14.checked {
					secSys.xUserEdt = x
					secSys.yUserEdt = y
				}
				else if mainForm.radiobutton15.checked {
					secSys.xPwdEdt = x
					secSys.yPwdEdt = y
				}
				else if mainForm.radiobutton16.checked {
					secSys.xImgLoginEdt = x
					secSys.yImgLoginEdt = y
				}
				else if mainForm.radiobutton17.checked {
					secSys.xImgTopLogin = x
					secSys.yImgTopLogin = y
				}
				else if mainForm.radiobutton18.checked {
					secSys.xImgBtomBtnLogin = x
					secSys.yImgBtomBtnLogin = y
				}
				else if mainForm.radiobutton19.checked {
					secSys.xBidOnce1Edt = x
					secSys.yBidOnce1Edt = y
				}
				else if mainForm.radiobutton20.checked {
					secSys.xBidOnce2Edt = x
					secSys.yBidOnce2Edt = y
				}
				else if mainForm.radiobutton21.checked {
					secSys.xBidOnceBtn = x
					secSys.yBidOnceBtn = y
				}
				else if mainForm.radiobutton22.checked {
					secSys.xIdNoEdt = x
					secSys.yIdNoEdt = y
				}	
				else if mainForm.radiobutton23.checked {
					secSys.xImgLogin2Edt = x
					secSys.yImgLogin2Edt = y
				}
				else if mainForm.radiobutton24.checked {
					secSys.xImgTopLogin2 = x
					secSys.yImgTopLogin2 = y
				}
				else if mainForm.radiobutton25.checked {
					secSys.xImgBtomBtnLogin2 = x
					secSys.yImgBtomBtnLogin2 = y
				}
				else if mainForm.radiobutton26.checked {
					secSys.xBtnLogin = x
					secSys.yBtnLogin = y
				}	
				else if mainForm.radiobutton27.checked {
					secSys.xBtnLogin2 = x
					secSys.yBtnLogin2 = y
				}
				else if mainForm.radiobutton28.checked {
					secSys.xCustomAddPriceEdt = x
					secSys.yCustomAddPriceEdt = y
				}
				else if mainForm.radiobutton29.checked {
					secSys.xCustomAddPriceBtn = x
					secSys.yCustomAddPriceBtn = y
				}									
				// 保存配置
				secSys.save()	
				// 重新加载配置
				updateCfg2Var()	
            }
            else if((kn == "F11")){
				/*xLog("start F7")
				//startThreadRecImg()
				pressF7("all")
				xLog("end F7")
				xLogFlush()
				*/
					
				getLastPriceByImg = function(){
					import recJppImageOcr
					return  recJppImageOcr.getImgPrice(xImgTopBtnFlagPrice, yImgTopBtnFlagPrice, xImgBtomBtnFlagPrice, yImgBtomBtnFlagPrice);
				}
				
				..io.print(getLastPriceByImg())
            }
            else if((kn == "F12")){
                mainForm.picturebox2.image = "\D:\jppweb\imgcode6_n.jpg"
				
				mainForm.picturebox2.redraw()
				mainForm.picturebox2.image = "D:\jppweb\imgcode6_y.jpg"
				mainForm.picturebox2.redraw()
				
				xLog("startCode")
				
				if (yzmType == "dmt") {
					jppDecode6Test("D:\jppweb\imgcode6_y.jpg")
				}
				elseif (yzmType == "uu"){
					gcodeTest = jppDecode6uuScreen(xImgTopBtn,yImgTopBtn , xImgBtomBtn-xImgTopBtn,yImgBtomBtn-yImgTopBtn)
				} else {
					//gcode = jppDecodeByImgLz("D:\jppweb\imgcode6.jpg","kaka21","qwer1234","kaka21")
				}
				
				
				string.trim(gcodeTest)
				mainForm.edit5.text  =  gcodeTest
				xLog("endCode")	
				xLogFlush() 
            }
          /*  else if(kn == "["){
            	//loginOnceAll()
            	..io.print("###cam Start")
            	startCamPauseRecordNew()

            }
            else if(kn == "="){
            	bidOnceAll()	
            }
            else if(kn == "]"){
            	bidTwiceAll()	
            }
            else if(kn == ";")  {   // 输入自定义价格
            	setCustomAddPriceEdtValue()
            }*/
            else if(kn == "F2"){  // 确认验证码
            	isYzmOk = "1"
				subThreadTable.threadRecImgConsoleFlag = "mend"   
				//subThreadTable.threadRecImgResult = getMunalYzm()
				//import thread
				//thread.terminate(gThreadRecImgReqOnceHandle,0)        	
            }/*
            else if(kn == "F5") {  // F7后，手动输入验证码完成后，可以F5手动确认验证码并进入出价确认判断
            // 全手动  F1 --》  F7 ---》 F5
            	isYzmOk = "1"
				subThreadTable.threadRecImgConsoleFlag = "mend"   
            
            	bidConfirmNice()
            	
            	subThreadTable.threadRecImgResult = "";
            	
            	
            	
				//	import mouse
				//	mouse.click( xImgTopBtn+10, yImgTopBtn+10,true); 
					
				//	win.delay(200)
					
				//	mouse.click(xImgBtomBtn-10, yImgBtomBtn-10, true);
				//	win.delay(100)
				
				isBidPageNice()
			
				bidNice2()
            }*/
            

           // io.print("°′??",kn)
        }
        case 0x101/*_WM_KEYUP*/,0x105/*_WM_SYSKEYUP*/{
            //io.print("μˉ?e",kn)
            if(kn=="F6"){
                //Pause="stop"
            }//éè??°′F6í?3?3ìDò
        }  
    }  
    }
}



getFtPrice = function(){
	var	nowTime = time.now()
	nowTime.format="%H%M%S";
	var nowTimeStr = tostring(nowTime) 
	
	var lastP =  cliGetLastPrice();
	
	
	try{
		lastPnum = tonumber(lastP);
		if (nowTimeStr == '112950')
		{
			lastPnum = lastPnum+700;
		}
		else {
			lastPnum = lastPnum + 1000;
		}
	}
	catch(e){
		lastPnum = 1234;
	}
	
	return tostring(lastPnum);
}


import win.timer
var timer = win.timer( mainForm );
timer.setInterval(1000)
timer.disable()

var timerImgClientHeartBeat = win.timer( mainForm );
timerImgClientHeartBeat.setInterval(100)
timerImgClientHeartBeat.enable()

subThreadTable.manualFlag = "0"   //  手动提交出价，手动输入完验证码后，按F2 , 设置 manualFlag  为  1， 不再接收远程调用命令
timerImgClientHeartBeat.onTimer = function(hwnd,msg,id,tick){
	var	nowTime = time.now()
	nowTime.format="%H%M%S";
	var nowTimeStr = tostring(nowTime) 
	
	
	//newform.edit.text = cliGetLastPrice();
	var lastP =   cliGetLastPrice();
	
	if (lastP = null)
	{
		lastP=999900;
	}
	
	newform.edtTime.text = getNowWithMsWithSep();
	newform.edtNewPrice.text = "最新:"+lastP;
	//newform.edtFtPrice.text = "估价:"+getFtPrice();
	
	try{
		var lastpnum = tonumber(lastP)
		if (nowTimeStr == '112950')
		{
			lastp50 = lastpnum;
		}
		else if (nowTimeStr == '112900') 	
		{ 	lastp00 = lastpnum; }
		else if (nowTimeStr == '112859') 	
		{ 	//lastp00 = lastpnum; 
			var jsPriceNum = tonumber(lowestPriceJS)
			var tmpIncAt29 = lastpnum- jsPriceNum
					
			
			if (tmpIncAt29 <= 400){  // 1500，1600，1700-1800
				bidPriceAt29 = jsPriceNum + 1500;
				bidPriceAt29_1 = jsPriceNum + 1600;
				bidPriceAt29_2 = jsPriceNum + 1700;
				bidPriceAt29_3 = jsPriceNum + 1800;
				bidPriceAt29_4 = jsPriceNum + 1900;
			}
			elseif(tmpIncAt29 >=500) and (tmpIncAt29 <= 700) { //  2100，2200，2300，2400-2500	
				bidPriceAt29 = jsPriceNum + 2100;
				bidPriceAt29_1 = jsPriceNum + 2200;
				bidPriceAt29_2 = jsPriceNum + 2300;
				bidPriceAt29_3 = jsPriceNum + 2400;
				bidPriceAt29_4 = jsPriceNum + 2500;			
			}
			elseif(tmpIncAt29 >=800) and (tmpIncAt29 <= 1000) { // 2200，2300，2400-2500
				bidPriceAt29 = jsPriceNum + 2200;
				bidPriceAt29_1 = jsPriceNum + 2300;
				bidPriceAt29_2 = jsPriceNum + 2400;
				bidPriceAt29_3 = jsPriceNum + 2500;
				bidPriceAt29_4 = jsPriceNum + 2600;			
			}
			else {  // 2500, 2600, 2700, 2800, 2900
				bidPriceAt29 = jsPriceNum + 2500;
				bidPriceAt29_1 = jsPriceNum + 2600;
				bidPriceAt29_2 = jsPriceNum + 2700;
				bidPriceAt29_3 = jsPriceNum + 2800;
				bidPriceAt29_4 = jsPriceNum + 2900;				
			}
			
			newform.edtIncAt29.text = "29分涨幅:"+tostring(tmpIncAt29)+"
加价:"+tostring(bidPriceAt29-jsPriceNum)+"
估价:"+tostring(bidPriceAt29)
			newform.edtFtPrice.text = "估价:"+tostring(bidPriceAt29)
		}
		else if (nowTimeStr == '112901')	{ lastp01 = lastpnum; }
		//else if (nowTimeStr == '112902')	{ lastp02 = lastpnum; }
		//else if (nowTimeStr == '112903')	{ lastp03 = lastpnum; }
		//else if (nowTimeStr == '112904')	{ lastp04 = lastpnum; }
		else if (nowTimeStr == '112905')	{ lastp05 = lastpnum; }
		//else if (nowTimeStr == '112906')	{ lastp06 = lastpnum; }
		//else if (nowTimeStr == '112907')	{ lastp07 = lastpnum; }
		//else if (nowTimeStr == '112908')	{ lastp08 = lastpnum; }
		//else if (nowTimeStr == '112909')	{ lastp09 = lastpnum; }
		else if (nowTimeStr == '112910')	{ lastp10 = lastpnum; }
		else if (nowTimeStr == '112911')	{ lastp11 = lastpnum; }
		//else if (nowTimeStr == '112912')	{ lastp12 = lastpnum; }
		//else if (nowTimeStr == '112913')	{ lastp13 = lastpnum; }
		//else if (nowTimeStr == '112914')	{ lastp14 = lastpnum; }
		else if (nowTimeStr == '112915')	{ lastp15 = lastpnum; }
		//else if (nowTimeStr == '112916')	{ lastp16 = lastpnum; }
		//else if (nowTimeStr == '112917')	{ lastp17 = lastpnum; }
		//else if (nowTimeStr == '112918')	{ lastp18 = lastpnum; }
		//else if (nowTimeStr == '112919')	{ lastp19 = lastpnum; }
		else if (nowTimeStr == '112920')	{ lastp20 = lastpnum; }
		//else if (nowTimeStr == '112921')	{ lastp21 = lastpnum; }
		//else if (nowTimeStr == '112922')	{ lastp22 = lastpnum; }
		//else if (nowTimeStr == '112923')	{ lastp23 = lastpnum; }
		//else if (nowTimeStr == '112924')	{ lastp24 = lastpnum; }
		else if (nowTimeStr == '112925')	{ lastp25 = lastpnum; }
		//else if (nowTimeStr == '112926')	{ lastp26 = lastpnum; }
		//else if (nowTimeStr == '112927')	{ lastp27 = lastpnum; }
		//else if (nowTimeStr == '112928')	{ lastp28 = lastpnum; }
		//else if (nowTimeStr == '112929')	{ lastp29 = lastpnum; }
		else if (nowTimeStr == '112930')	{ lastp30 = lastpnum; }
		//else if (nowTimeStr == '112931')	{ lastp31 = lastpnum; }
		//else if (nowTimeStr == '112932')	{ lastp32 = lastpnum; }
		//else if (nowTimeStr == '112933')	{ lastp33 = lastpnum; }
		//else if (nowTimeStr == '112934')	{ lastp34 = lastpnum; }
		else if (nowTimeStr == '112935')	{ lastp35 = lastpnum; }
		//else if (nowTimeStr == '112936')	{ lastp36 = lastpnum; }
		//else if (nowTimeStr == '112937')	{ lastp37 = lastpnum; }
		//else if (nowTimeStr == '112938')	{ lastp38 = lastpnum; }
		//else if (nowTimeStr == '112939')	{ lastp39 = lastpnum; }
		else if (nowTimeStr == '112940')	{ lastp40 = lastpnum; }
		else if (nowTimeStr == '112941')	{ lastp41 = lastpnum; }
		else if (nowTimeStr == '112942')	{ lastp42 = lastpnum; }
		else if (nowTimeStr == '112943')	{ lastp43 = lastpnum; }
		else if (nowTimeStr == '112944')	{ lastp44 = lastpnum; }
		else if (nowTimeStr == '112945')	{ lastp45 = lastpnum; }
		else if (nowTimeStr == '112946')	{ lastp46 = lastpnum; }
		else if (nowTimeStr == '112947')	{ lastp47 = lastpnum; }
		else if (nowTimeStr == '112948')	{ lastp48 = lastpnum; }
		else if (nowTimeStr == '112949')	{ lastp49 = lastpnum; }
		else if (nowTimeStr == '112950')	{ lastp50 = lastpnum; }
		else if (nowTimeStr == '112951')	{ lastp51 = lastpnum; }
		else if (nowTimeStr == '112952')	{ lastp52 = lastpnum;  delta52_50 = lastp52 - lastp50; }
		else if (nowTimeStr == '112953')	{ lastp53 = lastpnum;  delta53_50 = lastp53 - lastp50; }
		else if (nowTimeStr == '112954')	{ lastp54 = lastpnum;  delta54_50 = lastp54 - lastp50; }
		else if (nowTimeStr == '112955')	{ lastp55 = lastpnum;  delta55_50 = lastp55 - lastp50; }
		else if (nowTimeStr == '112956')	{ lastp56 = lastpnum; }
		else if (nowTimeStr == '112957')	{ lastp57 = lastpnum; }
		else if (nowTimeStr == '112958')	{ lastp58 = lastpnum; }
		else if (nowTimeStr == '112959')	{ lastp59 = lastpnum; }
		else if (nowTimeStr == '113000')	{ lastp60 = lastpnum; }		
	}
	catch(e){
		
	}
	

	
	var allBidFlag = subThreadTable.allbid   // 远程接收调用命令XX的变量， 
	
	if (allBidFlag == null) {
		allBidFlag = "0"   // allbidFlag 远程命令
	}
	
	..io.print(2176, "allBidFlag", allBidFlag)
	
	if (allBidFlag!=null) and (allBidFlag == "ccmdallbid") {
		subThreadTable.allbid = "0"
		//bidFinalAll()
		
		//设置手动标识，接受到管理端发送的自动出价命令后，不再进行任何处理
		if (subThreadTable.manualFlag != "1")   //  //  手动提交出价，手动输入完验证码后，按F2 , 设置 manualFlag  为  1， 不再接收远程调用命令
		{
			bidNice()
		}
		
	} elseif(allBidFlag!=null) and (allBidFlag == "ccmdalllogin"){
		subThreadTable.allbid = "0"
		loginOnceAll()
		
	}elseif(allBidFlag!=null) and (allBidFlag == "ccmdalloncebid"){
		subThreadTable.allbid = "0"
		bidOnceAll()
	
	}elseif(allBidFlag!=null) and (allBidFlag == "ccmdalltwicebid"){
		subThreadTable.allbid = "0"
		bidTwiceAll()
	}elseif(allBidFlag!=null) and (allBidFlag == "ccmdalltestbid"){
		subThreadTable.allbid = "0"
		bidTestAll()
	}elseif(allBidFlag!=null) and (allBidFlag == "ccmdallclkTipWindowConfirm"){ //点击确认框
		subThreadTable.allbid = "0"
		ccmdallclkTipWindowConfirm()
	}elseif(allBidFlag!=null) and (allBidFlag == "ccmdallclkTipWindowConfirmTest"){ // 点击测试确认按钮
		subThreadTable.allbid = "0"
		ccmdallclkTipWindowConfirmTest()
	}
	elseif(allBidFlag!=null) and (allBidFlag == "ccmdallclkOpenWebTest"){ // 点击打开测试页面链接
		subThreadTable.allbid = "0"
		ccmdallclkOpenWebTest()
	}
	elseif(allBidFlag!=null) and (allBidFlag == "ccmdallclkIETip"){ // 点击IE重启地提示框
		subThreadTable.allbid = "0"
		ccmdallclkIETip()
	}
	elseif(allBidFlag!=null) and (allBidFlag == "ccmdallsnapscreen"){ //截取全屏
		subThreadTable.allbid = "0"
		ccmdallsnapscreen()
	}
	elseif(allBidFlag!=null) and (allBidFlag == "ccmdallstartcam"){ //全部开始录像
		subThreadTable.allbid = "0"
            	startCamPauseRecordNew()
	}
	elseif(allBidFlag!=null) and (allBidFlag == "ccmdallopenpage"){ //地址栏输入网址，并点击进入
		subThreadTable.allbid = "0"
		openLoginPageAll()
	}
	else {
		subThreadTable.allbid = "0"
	}
	
	//..io.print(  2438 , allBidFlag, clientIp, "strIndexOF",string.indexOf(allBidFlag, "0"))
	
	..io.print( nowTimeStr, "win.timer wait cCmd allBidFlag Call xxx:" , allBidFlag, clientIp)
	
	if (allBidFlag!=null) and (string.indexOf(allBidFlag, clientIp)!=null){
		..io.print("2543", allBidFlag, "bid in")
	
		if (string.indexOf(allBidFlag,"allbid")!=null){
			subThreadTable.allbid = "0"	
			//bidFinalAll()
			bidNice()
			//bidNiceAt29Auto(tostring(bidPriceAt29+tonumber(priceBefore)))
		}elseif (string.indexOf(allBidFlag,"oncelogin")!=null){
			subThreadTable.allbid = "0"	
			loginOnceAll()
		}elseif (string.indexOf(allBidFlag,"alloncebid")!=null){
			subThreadTable.allbid = "0"	
			bidOnceAll()
		}elseif (string.indexOf(allBidFlag,"alltwicebid")!=null){
			subThreadTable.allbid = "0"	
			bidTwiceAll()
		}elseif (string.indexOf(allBidFlag,"alltestbid")!=null){
			subThreadTable.allbid = "0"	
			//bidTestAll()
			bidNiceAt29Auto(tostring(bidPriceAt29+tonumber(priceBefore)))
		}
		else {
			subThreadTable.allbid = "0"
		}
		
	}	
	
}


var timerCheckAllBideFlag = win.timer( mainForm );
timerCheckAllBideFlag.setInterval(1000)
timerCheckAllBideFlag.enable()





mainForm.button.oncommand = function(id,event){
	timer.disable()
	timer.enable()
	gDoneTimer = "0"
}

import time
gDoneTimer = "0"
//startTimeStr = "021620"
//endTimeStr =   "021622"
//startTimeStrSecond2 = startTimeStrSecond + 2

gF3Done = ""

timer.onTimer = function(hwnd,msg,id,tick){
	nowTime = time.now()
	nowTime.format="%H%M%S";
	
	nowTimeStr = tostring(nowTime) 
	//nowTime2 = nowTime.addsecond(2)
	
	
	/*
	var lastPrice = getSubLastPrice()
	
	if string.indexOf(lastPrice, "reLoadIni")
	
	*/
	
	
	var lPriceStr = cliGetLastPrice()
	lPriceNum = tonumber(lPriceStr)
	
	/*
	//win.delay(100)
	..io.print(1730, "priceBidCur:", curBidPriceNum, "lastPrice:", lPriceNum)
	if (lPriceNum >= 10000) {
		..io.print("add 10000", lPriceNum)
	}elseif (lPriceNum >= 10000-100){
		..io.print("add 9900", lPriceNum)
	}
		
	*/		
			
	
	
	
	// 自动登陆 9:30
	if (nowTimeStr == login1TimeStr)
	{		
	//	loginOnceAll()	

	}
	
	// 首次出价  10:32
	if (nowTimeStr == bid1TimeStr)
	{	
	//	bidOnceAll()		

	}
	
	
	// 二次出价  11:02
	if (nowTimeStr == bid2TimeStr)
	{	
	//	bidTwiceAll()		
	}
	
	
	// 最后一分钟开始录像
	if (nowTimeStr == "112900")
	{
	//	startCamPauseRecord()
	}
	
	
    //  停止录像
	if (nowTimeStr == "115000")
	{
	//	startCamPauseRecord()
	//	win.delay(10000)
	//	stopCamRecord()
	}
	
	
	
	// 在最终出价前，再提前模拟一次出价，为了提高最终取验证码的速度  112920 112925
	if (nowTimeStr == bidTimeStr)
	{
	/*
		pressF1()
		win.delay(2000)
		pressF7(yzmType)
		win.delay(2000)
		clkBidCancel300() 
		//jppDecode6Test("D:\jppweb\imgcode6_y.jpg")
		*/
	}
	
	
	// 最终出价  112900
	if ( (nowTimeStr == bid3Time) ){	
		//timer.disable()
	//	bidFinalAll()	
	}
	
	// 最终出价
	/*
	if (manualBid == "1")
	{
		nowTime = time.now()
		nowTime.format="%H%M%S";
		nowTimeStr = tostring(nowTime) 
				
		if ( (nowTimeStr == startTimeStr)  //and (nowTimeStr < endTimeStr)
				//and (gDoneTimer = "0") 
				){	
			//timer.disable()
			
			//gDoneTimer = "1"
			// 提交出价
			pressF1()
			
		}
		
		if ( nowTimeStr == endTimeStr){
			_Beep(3000, 100)
		}
		
			
		// 如果已经输入完成验证码，并确认，则进入自动提交出价逻辑
		if (isYzmOk == "1")
		{ // 自动出价
			
			// 提交
			curBidPriceNum = tonumber(curBidPriceStr)
			var curBidPriceNumSub100 = curBidPriceNum - 100
			while(true){	
				//win.delay(20)
				
				nowTime = time.now()
				nowTime.format="%H%M%S";
				nowTimeStr = tostring(nowTime) 
				
				var lPriceStr = cliGetLastPrice()
				lPriceNum = tonumber(lPriceStr)
				
				if ( nowTimeStr == endTimeStr){
					_Beep(3000, 100)
				}
	
				if(nowTimeStr<endTimeStr){ // 未到最后出价时间
					win.delay(25)
					
					..io.print(1977, "manual--curPriceBid:", curBidPriceNum, "lastPrice:", lPriceNum)
					
					if (lPriceNum >= curBidPriceNum) { // 如果，目前最高价，大于出价，立即发出
						pressF3()
						break;	
					}elseif (lPriceNum >= curBidPriceNumSub100){ // 如果最高价 距离 出价 还有 1个档位，立即出价
						//if 	(nowTimeStr>="112950")	{ // 50秒后，价格还差100，就可以选择出价了
							pressF3()
							break;	
						//}
					}
					
					
				}else {  // 到了最后出价时间，不管任何情况，选择出价 // 53秒后，不管任何情况都应该出价了
					..io.print(2000, "manual--curPriceBid-finnal:", curBidPriceNum, "lastPrice:", lPriceNum)
					pressF3()
					break;	
					
				}	
			}	
			//mainForm.checkbox2.checked = false
			isYzmOk = 0	
		}
		
	} 
	else { // ###自动最终出价
		//startCamPauseRecord()
		if ( (nowTimeStr == startTimeStr) ){	
			//timer.disable()
			bidFinalAll()	
		}
	}
	*/




} 


mainForm.edit16.oncommand = function(id,event){
	//mainForm.msgbox( mainForm.edit16.text );
	lowestPriceJS = mainForm.edit16.text
	secSys.lowestPriceJS =  lowestPriceJS
	secSys.save()
}


mainForm.button3.oncommand = function(id,event){
	//mainForm.msgbox( mainForm.button3.text );
	timer.disable()
	openPriceSvr()	
}

mainForm.button7.oncommand = function(id,event){
	//mainForm.msgbox( mainForm.button7.text );
	//responder.sendMsg("pallbid")	
	//	pressF1()
	//	pressF7(yzmType)	
	//	pressF3()	
	
	//bidFinalAll()
	bidNice()
}



mainForm.button12.oncommand = function(id,event){
	//mainForm.msgbox( mainForm.button12.text );
	
	bidTestAll()	
}




mainForm.button8.oncommand = function(id,event){
	//mainForm.msgbox( mainForm.button8.text );
	loginOnceAll()
	//responder.sendMsg("palllogin")	
}


mainForm.button9.oncommand = function(id,event){
	//mainForm.msgbox( mainForm.button8.text );
	bidOnceAll()
	//responder.sendMsg("palloncebid")	
}


mainForm.button10.oncommand = function(id,event){
	//mainForm.msgbox( mainForm.button8.text );
	bidTwiceAll()
	//responder.sendMsg("palltwicebid")	
}


mainForm.button11.oncommand = function(id,event){
	//mainForm.msgbox( mainForm.button11.text );
	openLoginPageAll()
}


mainForm.show() 
mainForm.show(0x6/*_SW_MINIMIZE*/)





//var wb = win.form( newform  ); 
//mainForm.sho
//win.form(newform, _Sw
newform.show()


//jppForm[TID:11832]
import winex
winHandle = winex.find("<.+>", "最新价");
//winHandleMain = winex.find("<.+>", "好运来拍牌");



//winHandle = win.find("Notepad","o???à′????");

..io.print("1111111111111111111",winHandle)
win.setTopmost(winHandle, true);



//mainForm.edit.oncommand = function(id,event){
	//mainForm.msgbox( mainForm.edit.text );
//	newform.edit.text = mainForm.edit.text;	
//}


//win.show(winHandleMain,0x6/*_SW_MINIMIZE*/)



//win.setForeground(win.find("","好运来拍牌"))
//mainForm.show(_SW_	

ioConsoleWnd = win.find("ConsoleWindowClass","jpp.exe")
win.show(ioConsoleWnd,0x6/*_SW_MINIMIZE*/)



ioConsoleWnd1 = win.find("ConsoleWindowClass","aardio.exe")
win.show(ioConsoleWnd1,0x6/*_SW_MINIMIZE*/)

//startCamPauseRecord()


startAutoPubPriceVersion = function(){
	timer.disable()
	gStopFlag = "0"
	openPriceSvr()
	
	
	mainForm.button6.text = mainForm.button6.text + "开始"
}

startFullManualVersion = function(){
	manualYzm = "1"	
	manualBid = "1"
}

startHalfManualVersion = function(){
	
}



 //  获取  验证码 辅助 说明 图像识别结果
function getImgSbmByImg(path){	

	//获取图像像素数据
	pixLastPrice = liblept.pixRead(path);	
	ocr.setImage2( pixLastPrice );	
	
	//识别图像
	if( 0 != ocr.recognize() ){
		..io.print(1226,"识别图像出错");
		return "";
	}
	var result = ocr.getText(); 	
	try{
		num = tonumber(result)
	}
		catch(e){	
	}
	result = string.trim(result)
	result = string.replace(result," ","")
	xLog(path+"="+result)
	return  result; 
}

getImgSbmByImg("C:\Users\admin\Desktop\jpp###Doc\201601\224\imgSbm.jpg")

getImgSbmByImg("C:\Users\admin\Desktop\jpp###Doc\201601\221\imgSbm.jpg")

getImgSbmByImg("C:\Users\admin\Desktop\jpp###Doc\201601\223\imgSbm.jpg")


xLog("程序启动完成,行情线程,验证码发送线程,拍牌定时器持续扫描运行...")
xLogFlush()


getImgSbmByImg("C:\Users\admin\Desktop\yzmFailSbm\002824_b.jpg")
getImgSbmByImg("C:\Users\admin\Desktop\yzmFailSbm\101940_hbid1.jpg")
getImgSbmByImg("C:\Users\admin\Desktop\yzmFailSbm\110812_zzhq.jpg")
getImgSbmByImg("C:\Users\admin\Desktop\yzmFailSbm\112934_sx1.jpg")
getImgSbmByImg("C:\Users\admin\Desktop\yzmFailSbm\113057_sx2.jpg")
getImgSbmByImg("C:\Users\admin\Desktop\yzmFailSbm\134023_h.jpg")


//version-1 自动启动价格发布版本
//startAutoPubPriceVersion()

//version-2 全手动版
//startFullManualVersion()

//version-3 半手动版
//startHalfManualVersion()


return win.loopMessage(); 




